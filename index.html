    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SwiftMeet - Modern Appointment Scheduling</title>
        
        <script src="https://cdn.tailwindcss.com"></script>
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        <!-- Make sure to use your own API key in a real application -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZi8-iB7RXkSldq-MkaIhw2QIQX9SoQ0&libraries=places,geometry"></script>

        <style>
            :root {
                --primary: #4f46e5;
                --primary-dark: #4338ca;
                --primary-light: #818cf8;
                --secondary: #10b981;
                --accent: #f59e0b;
                --danger: #ef4444;
                --gray-50: #f9fafb;
                --gray-100: #f3f4f6;
                --gray-200: #e5e7eb;
                --gray-300: #d1d5db;
                --gray-400: #9ca3af;
                --gray-500: #6b7280;
                --gray-600: #4b5563;
                --gray-700: #374151;
                --gray-800: #1f2937;
                --gray-900: #111827;
            }
            
            body {
                font-family: 'Poppins', sans-serif;
                background-color: var(--gray-50);
                color: var(--gray-800);
                overflow-x: hidden;
            }
            
            .view {
                display: none;
                animation: fadeIn 0.6s ease-in-out;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .form-input {
                transition: all 0.3s ease;
                border-radius: 10px;
                padding: 0.75rem 1rem;
                border: 1px solid var(--gray-300);
                background-color: white;
            }
            
            .form-input:focus {
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
                border-color: var(--primary);
            }
            
            .btn-primary {
                background-color: var(--primary);
                color: white;
                transition: all 0.3s ease;
                border-radius: 10px;
                font-weight: 600;
                padding: 0.75rem 1.5rem;
            }
            
            .btn-primary:hover {
                background-color: var(--primary-dark);
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }

            .btn-primary:disabled {
                background-color: var(--gray-300);
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            .card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                border-radius: 16px;
                overflow: hidden;
                background: white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            }
            
            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            .ai-suggestion-card {
                background: linear-gradient(135deg, var(--primary), var(--primary-light));
                border: none;
                color: white;
            }
            
            /* --- STYLES FOR NEW LOGIN PAGE --- */
            .hero-bg {
                background-image: linear-gradient(to right, rgba(17, 24, 39, 0.9), rgba(55, 48, 163, 0.8)), url('https://images.unsplash.com/photo-1521791136064-7986c2920216?q=80&w=1200&auto=format&fit=crop');
                background-size: cover;
                background-position: center;
            }
            
            @keyframes fade-in-down {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes slide-out-up {
                from { opacity: 1; transform: translateY(0); max-height: 200px; }
                to { opacity: 0; transform: translateY(-20px); max-height: 0; padding: 0; margin: 0; border: 0;}
            }
            
            @keyframes slide-in-down {
                from { opacity: 0; transform: translateY(-20px); max-height: 0; }
                to { opacity: 1; transform: translateY(0); max-height: 200px; }
            }
            
            .animate-fade-in-down { animation: fade-in-down 0.8s ease-out forwards; }
            .animate-slide-out-up { animation: slide-out-up 0.5s ease-in-out forwards; }
            .animate-slide-in-down { animation: slide-in-down 0.5s ease-in-out forwards; }
            
            #register-form-fields.hidden {
                display: none;
            }
            
            /* New styles for floating labels and inputs */
            .auth-input {
                width: 100%;
                padding-left: 3rem;
                padding-right: 1rem;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
                background-color: rgba(255, 255, 255, 0.05);
                border: 2px solid transparent;
                border-radius: 10px;
                color: white;
                transition: all 0.3s ease;
            }
            
            .auth-input::placeholder {
                color: transparent;
            }
            
            .auth-input:focus {
                background-color: rgba(255, 255, 255, 0.1);
                outline: none;
                border-color: var(--primary);
            }
            
            .auth-label {
                position: absolute;
                left: 3rem;
                top: 0.85rem;
                color: var(--gray-400);
                transition: all 0.3s ease;
                pointer-events: none;
            }
            
            .auth-input:not(:placeholder-shown) + .auth-label,
            .auth-input:focus + .auth-label {
                transform: translateY(-1.5rem) translateX(-0.25rem) scale(0.75);
                color: var(--primary-light);
            }
            
            /* Enhanced header */
            .app-header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            /* Enhanced buttons */
            .btn-secondary {
                background-color: var(--secondary);
                color: white;
                border-radius: 10px;
                font-weight: 600;
                padding: 0.75rem 1.5rem;
                transition: all 0.3s ease;
            }
            
            .btn-secondary:hover {
                background-color: #0da271;
                transform: translateY(-2px);
            }
            
            .btn-danger {
                background-color: var(--danger);
                color: white;
                border-radius: 10px;
                font-weight: 600;
                padding: 0.75rem 1.5rem;
                transition: all 0.3s ease;
            }
            
            .btn-danger:hover {
                background-color: #dc2626;
                transform: translateY(-2px);
            }

            .btn-warning {
                background-color: var(--accent);
                color: white;
                border-radius: 10px;
                font-weight: 600;
                padding: 0.5rem 1rem;
                transition: all 0.3s ease;
            }

            .btn-warning:hover {
                background-color: #e8910a;
                transform: translateY(-2px);
            }
            
            /* Badge styles */
            .badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
            }
            
            .badge-primary {
                background-color: var(--primary);
                color: white;
            }
            
            .badge-secondary {
                background-color: var(--secondary);
                color: white;
            }
            
            .badge-accent {
                background-color: var(--accent);
                color: white;
            }

            .badge-danger {
                background-color: var(--danger);
                color: white;
            }

            .badge-success {
                background-color: var(--secondary);
                color: white;
            }

            .badge-gray {
                background-color: var(--gray-200);
                color: var(--gray-700);
            }
            
            /* Stats cards */
            .stat-card {
                background: linear-gradient(135deg, var(--primary), var(--primary-light));
                color: white;
                border-radius: 16px;
                padding: 1.5rem;
            }
            
            /* Service cards */
            .service-card {
                border-radius: 16px;
                overflow: hidden;
                background: white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
            }
            
            .service-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }
            
            /* Modal enhancements */
            .modal-overlay {
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(5px);
            }
            
            .modal-content {
                border-radius: 20px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Loading spinner */
            .loading-spinner {
                display: inline-block;
                width: 80px;
                height: 80px;
            }
            
            .loading-spinner:after {
                content: " ";
                display: block;
                width: 64px;
                height: 64px;
                margin: 8px;
                border-radius: 50%;
                border: 6px solid var(--primary);
                border-color: var(--primary) transparent var(--primary) transparent;
                animation: loading-spinner 1.2s linear infinite;
            }
            
            @keyframes loading-spinner {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* Custom scrollbar */
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-track {
                background: var(--gray-100);
                border-radius: 10px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: var(--gray-400);
                border-radius: 10px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: var(--gray-500);
            }
            
            /* Animation for success checkmark */
            .checkmark {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                display: block;
                stroke-width: 2;
                stroke: #4bb71b;
                stroke-miterlimit: 10;
                box-shadow: inset 0px 0px 0px #4bb71b;
                animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
            }
            
            .checkmark__circle {
                stroke-dasharray: 166;
                stroke-dashoffset: 166;
                stroke-width: 2;
                stroke-miterlimit: 10;
                stroke: #4bb71b;
                fill: none;
                animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
            }
            
            .checkmark__check {
                transform-origin: 50% 50%;
                stroke-dasharray: 48;
                stroke-dashoffset: 48;
                animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
            }
            
            @keyframes stroke {
                100% { stroke-dashoffset: 0; }
            }
            
            @keyframes scale {
                0%, 100% { transform: none; }
                50% { transform: scale3d(1.1, 1.1, 1); }
            }
            
            @keyframes fill {
                100% { box-shadow: inset 0px 0px 0px 30px #4bb71b; }
            }
            
            /* Pulse animation for notifications */
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            .pulse {
                animation: pulse 2s infinite;
            }
            
            /* NEW ANIMATIONS FOR SLOTS PAGE */
            
            /* Floating animation for AI suggestion */
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
            }
            
            .float-animation {
                animation: float 6s ease-in-out infinite;
            }
            
            /* Slide in from right animation */
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            .slide-in-right {
                animation: slideInRight 0.5s ease-out forwards;
            }
            
            /* Slot hover effects */
            .slot-item {
                transition: all 0.3s ease;
                border-radius: 12px;
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }
            
            .slot-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                transition: left 0.5s;
            }
            
            .slot-item:hover::before {
                left: 100%;
            }
            
            .slot-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                border-color: var(--primary);
            }
            
            /* Glow effect for AI recommended slots */
            .ai-recommended {
                position: relative;
                border: 2px solid transparent;
                background: linear-gradient(white, white) padding-box,
                            linear-gradient(135deg, var(--primary), var(--accent)) border-box;
                animation: glow 2s ease-in-out infinite alternate;
            }
            
            @keyframes glow {
                from { box-shadow: 0 0 5px var(--primary-light); }
                to { box-shadow: 0 0 15px var(--primary-light); }
            }
            
            /* Bounce animation for attention */
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
                40% {transform: translateY(-10px);}
                60% {transform: translateY(-5px);}
            }
            
            .bounce {
                animation: bounce 2s infinite;
            }
            
            /* Fade in up animation */
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .fade-in-up {
                animation: fadeInUp 0.5s ease-out forwards;
            }
            
            /* Staggered animation for slot items */
            .slot-item:nth-child(1) { animation-delay: 0.1s; }
            .slot-item:nth-child(2) { animation-delay: 0.2s; }
            .slot-item:nth-child(3) { animation-delay: 0.3s; }
            .slot-item:nth-child(4) { animation-delay: 0.4s; }
            .slot-item:nth-child(5) { animation-delay: 0.5s; }
            .slot-item:nth-child(6) { animation-delay: 0.6s; }
            
            /* Page transition animations */
            .page-enter {
                opacity: 0;
                transform: translateX(100%);
            }
            
            .page-enter-active {
                opacity: 1;
                transform: translateX(0);
                transition: opacity 0.5s, transform 0.5s;
            }
            
            .page-exit {
                opacity: 1;
                transform: translateX(0);
            }
            
            .page-exit-active {
                opacity: 0;
                transform: translateX(-100%);
                transition: opacity 0.5s, transform 0.5s;
            }
            
            /* NEW: Animation for AI analysis */
            @keyframes aiThinking {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            .ai-thinking {
                animation: aiThinking 2s ease-in-out infinite;
            }
            
            /* NEW: Shimmer effect for loading */
            @keyframes shimmer {
                0% { background-position: -468px 0; }
                100% { background-position: 468px 0; }
            }
            
            .shimmer {
                animation-duration: 1.5s;
                animation-fill-mode: forwards;
                animation-iteration-count: infinite;
                animation-name: shimmer;
                animation-timing-function: linear;
                background: #f6f7f8;
                background: linear-gradient(to right, #eeeeee 8%, #dddddd 18%, #eeeeee 33%);
                background-size: 800px 104px;
                position: relative;
            }
            
            /* NEW: Travel time info styles */
            .travel-time-info {
                background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                border: 1px solid #bae6fd;
                border-radius: 10px;
                padding: 12px;
                margin-top: 10px;
            }
            
            .travel-time-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            
            .travel-time-label {
                font-weight: 600;
                color: #0369a1;
            }
            
            .travel-time-value {
                font-weight: 700;
                color: #0c4a6e;
            }
            
            /* NEW: Rating styles */
            .rating-stars {
                display: flex;
                align-items: center;
            }
            
            .star {
                color: #fbbf24;
                margin-right: 2px;
            }
            
            .rating-value {
                font-weight: 600;
                margin-left: 5px;
                color: #f59e0b;
            }
            
            /* NEW: Enhanced Slots Page Styles */
            .slot-day-group {
                margin-bottom: 2rem;
            }
            
            .slot-day-header {
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                margin-bottom: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .slot-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .time-slot {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 1rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .time-slot::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.1), transparent);
                transition: left 0.5s;
            }
            
            .time-slot:hover::before {
                left: 100%;
            }
            
            .time-slot:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.2);
                border-color: #4f46e5;
            }
            
            .time-slot.selected {
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                color: white;
                border-color: #4f46e5;
                transform: scale(1.05);
            }
            
            .time-slot.ai-recommended {
                border: 2px solid transparent;
                background: linear-gradient(white, white) padding-box,
                            linear-gradient(135deg, #4f46e5, #f59e0b) border-box;
                animation: glow 2s ease-in-out infinite alternate;
            }
            
            .time-slot.ai-recommended::after {
                content: 'AI Pick';
                position: absolute;
                top: -8px;
                right: -8px;
                background: #f59e0b;
                color: white;
                font-size: 0.7rem;
                padding: 2px 8px;
                border-radius: 10px;
                font-weight: 600;
            }
            
            .slot-time {
                font-size: 1.1rem;
                font-weight: 700;
                margin-bottom: 0.25rem;
            }
            
            .slot-availability {
                font-size: 0.8rem;
                opacity: 0.8;
            }
            
            .service-info-panel {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 16px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .progress-bar {
                height: 6px;
                background: #e5e7eb;
                border-radius: 3px;
                overflow: hidden;
                margin: 1rem 0;
            }
            
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #10b981, #34d399);
                border-radius: 3px;
                transition: width 0.5s ease;
            }
            
            .feature-card {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                transition: all 0.3s ease;
                border: 1px solid #e5e7eb;
            }
            
            .feature-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1);
            }
            
            .feature-icon {
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 1rem;
                color: white;
                font-size: 1.5rem;
            }
            
            .quick-actions {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-top: 1rem;
            }
            
            .quick-action-btn {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 10px;
                padding: 0.75rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 0.9rem;
                font-weight: 500;
            }
            
            .quick-action-btn:hover {
                background: #4f46e5;
                color: white;
                transform: translateY(-2px);
            }
            
            .confirmation-step {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1rem;
                border-left: 4px solid #4f46e5;
            }
            
            .step-number {
                width: 30px;
                height: 30px;
                background: #4f46e5;
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                margin-right: 1rem;
            }
            
            /* Enhanced animations */
            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .slide-in-up {
                animation: slideInUp 0.5s ease-out;
            }
            
            @keyframes pulse-gentle {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
            
            .pulse-gentle {
                animation: pulse-gentle 3s infinite;
            }
            
            /* NEW: Profile Modal Styles */
            .profile-modal {
                max-width: 500px;
                width: 90%;
            }
            
            .profile-image-container {
                position: relative;
                width: 120px;
                height: 120px;
                margin: 0 auto 1.5rem;
            }
            
            .profile-image {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
                border: 4px solid var(--primary);
            }
            
            .profile-image-upload {
                position: absolute;
                bottom: 0;
                right: 0;
                background: var(--primary);
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }
            
            /* NEW: Service Image Styles */
            .service-image {
                height: 200px;
                width: 100%;
                object-fit: cover;
                background-color: #e5e7eb;
                background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 3rem;
            }
            
            .service-image-fallback {
                height: 200px;
                width: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 3rem;
            }
            
            /* NEW: Enhanced AI Recommendation Styles */
            .ai-recommendation-card {
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                color: white;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            
            .ai-insight-item {
                display: flex;
                align-items: flex-start;
                padding: 0.75rem;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                margin-bottom: 0.5rem;
            }
            
            .ai-insight-icon {
                margin-right: 0.75rem;
                font-size: 1.25rem;
                margin-top: 0.125rem;
            }
            
            /* NEW: Enhanced Travel Planning Styles */
            .travel-planning-card {
                background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                border: 1px solid #bae6fd;
                border-radius: 12px;
                padding: 1.25rem;
                margin-top: 1rem;
            }
            
            .travel-route-info {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }
            
            .travel-time-badge {
                background: #0ea5e9;
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.875rem;
                font-weight: 600;
            }
            
            .travel-suggestion {
                background: white;
                padding: 0.75rem;
                border-radius: 8px;
                margin-top: 0.75rem;
                border-left: 4px solid #0ea5e9;
            }
            
            /* NEW: Service Type Icons */
            .service-icon {
                width: 4.5rem; /* 72px */
                height: 4.5rem; /* 72px */
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 1rem;
                color: white;
                font-size: 2rem; /* 32px */
                transition: all 0.3s ease;
            }
            .service-icon-hospital { background: linear-gradient(135deg, #ef4444, #f87171); }
            .service-icon-gym { background: linear-gradient(135deg, #10b981, #34d399); }
            .service-icon-salon { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
            .service-icon-restaurant { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
            .service-icon-default { background: linear-gradient(135deg, #6b7280, #9ca3af); }

            .popular-service-card {
                background: white;
                padding: 1.5rem;
                border-radius: 16px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            }
            .popular-service-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
            }
            .popular-service-card:hover .service-icon {
                transform: scale(1.1);
            }
            
            /* NEW: Enhanced Search Form Styles */
            .location-input-container {
                position: relative;
            }
            
            .current-location-btn {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: #f3f4f6;
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .current-location-btn:hover {
                background: #e5e7eb;
            }
            
            .current-location-btn.active {
                background: #4f46e5;
                color: white;
            }
            
            /* NEW: Enhanced Slots List Styles */
            .slots-list-container {
                background: white;
                border-radius: 16px;
                padding: 1.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            }
            
            .service-slots-group {
                margin-bottom: 2rem;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                overflow: hidden;
            }
            
            .service-slots-header {
                background: #f9fafb;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid #e5e7eb;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .service-slots-header:hover {
                background: #f3f4f6;
            }
            
            .service-slots-header.active {
                background: #4f46e5;
                color: white;
            }
            
            .service-slots-content {
                padding: 1.5rem;
                display: none;
            }
            
            .service-slots-content.active {
                display: block;
            }
            
            .ai-suggested-slots {
                margin-bottom: 2rem;
            }
            
            .ai-suggested-header {
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
            }
            
            .ai-suggested-header i {
                margin-right: 0.75rem;
                font-size: 1.25rem;
            }
            
            .traffic-details {
                background: #f0f9ff;
                border: 1px solid #bae6fd;
                border-radius: 8px;
                padding: 0.75rem;
                margin-top: 0.75rem;
                font-size: 0.875rem;
            }
            
            .traffic-details-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.25rem;
            }
            
            .traffic-label {
                font-weight: 600;
                color: #0369a1;
            }
            
            .traffic-value {
                font-weight: 700;
                color: #0c4a6e;
            }
            
            .distance-details {
                display: flex;
                align-items: center;
                margin-top: 0.5rem;
                color: #4b5563;
                font-size: 0.875rem;
            }
            
            .distance-details i {
                margin-right: 0.5rem;
                color: #6b7280;
            }
            
            /* NEW: Hero Section Styles */
            .hero-section {
                background: linear-gradient(135deg, #4f46e5 0%, #7c73e6 100%);
                color: white;
                padding: 4rem 0;
                border-radius: 0 0 30px 30px;
            }
            
            .hero-image {
                max-width: 100%;
                height: auto;
                border-radius: 20px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
            
            .feature-highlight {
                background: white;
                border-radius: 16px;
                padding: 2rem;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.05);
                transition: all 0.3s ease;
            }
            
            .feature-highlight:hover {
                transform: translateY(-10px);
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
            
            .feature-icon-large {
                width: 80px;
                height: 80px;
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 1.5rem;
                color: white;
                font-size: 2rem;
            }

            .feature-image {
                width: 100%;
                height: 180px;
                object-fit: cover;
                border-radius: 12px;
                margin-bottom: 1.5rem;
                background-color: var(--gray-200);
            }
            
            /* NEW: Admin Dashboard Styles */
            .admin-nav {
                background: white;
                border-radius: 16px;
                padding: 1.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                margin-bottom: 2rem;
            }
            
            .admin-nav-item {
                padding: 1rem 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                margin-bottom: 0.5rem;
                font-weight: 500;
            }
            
            .admin-nav-item:hover {
                background: #f3f4f6;
                color: var(--primary-dark);
            }
            
            .admin-nav-item.active {
                background: var(--primary);
                color: white;
                box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
            }
            
            .admin-nav-item i {
                margin-right: 0.75rem;
                width: 20px;
                text-align: center;
            }
            
            .admin-content-section {
                display: none;
            }
            
            .admin-content-section.active {
                display: block;
                animation: fadeIn 0.5s ease-out;
            }
            
            /* NEW: Service Management Styles */
            .service-management-card {
                background: white;
                border-radius: 16px;
                padding: 2rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                margin-bottom: 2rem;
            }
            
            .service-list-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                margin-bottom: 1rem;
                transition: all 0.3s ease;
            }
            
            .service-list-item:hover {
                border-color: var(--primary);
                box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1);
            }
            
            /* NEW: Slot Management Styles */
            .slot-management-card {
                background: white;
                border-radius: 16px;
                padding: 2rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            }
            
            .slot-calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 0.5rem;
                margin-bottom: 2rem;
            }
            
            .calendar-day {
                padding: 1rem;
                text-align: center;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .calendar-day:hover {
                background: #f3f4f6;
            }
            
            .calendar-day.active {
                background: var(--primary);
                color: white;
            }
            
            .time-slot-management {
                background: #f9fafb;
                border-radius: 10px;
                padding: 1rem;
                margin-bottom: 1rem;
                border: 1px solid var(--gray-200);
            }
            
            .time-slot-management-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            /* NEW: Enhanced User Dashboard */
            .user-dashboard-card {
                background: white;
                border-radius: 16px;
                padding: 2rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                margin-bottom: 2rem;
            }

            /* Realtime feel: animate key list items when they appear */
            .user-booking-item,
            .service-list-item,
            .time-slot-management {
                animation: fadeInUp 0.4s ease-out;
            }
            
            .dashboard-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            
            .stat-item {
                background: linear-gradient(135deg, #4f46e5, #7c73e6);
                color: white;
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                transition: all 0.3s ease;
            }
            .stat-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
            }
            
            .stat-value {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
            }
            
            .stat-label {
                font-size: 0.875rem;
                opacity: 0.9;
            }

            /* NEW: Custom Message Box */
            .message-box-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index:50;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            .message-box-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .message-box {
                background: white;
                border-radius: 16px;
                padding: 2rem;
                width: 90%;
                max-width: 450px;
                text-align: center;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                transform: scale(0.95);
                transition: transform 0.3s ease;
            }
            .message-box-overlay.visible .message-box {
                transform: scale(1);
            }
            .message-box-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--gray-900);
                margin-bottom: 0.75rem;
            }
            .message-box-content {
                font-size: 1rem;
                color: var(--gray-600);
                margin-bottom: 1.5rem;
            }
            .message-box-buttons {
                display: flex;
                gap: 0.75rem;
                justify-content: center;
            }
            
            /* NEW: Responsive Design Improvements */
            @media (max-width: 768px) {
                .hero-section {
                    padding: 2rem 0;
                    border-radius: 0 0 20px 20px;
                    text-align: center;
                }

                .hero-section .flex-col {
                    align-items: center;
                }
                
                .feature-highlight {
                    padding: 1.5rem;
                    margin-bottom: 1rem;
                }
                
                .service-management-card, .user-dashboard-card {
                    padding: 1.5rem;
                }
                
                .slot-grid {
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                }

                .admin-nav-item {
                    padding: 0.75rem 1rem;
                    font-size: 0.875rem;
                }

                .service-list-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }

                .service-list-item > div:last-child {
                    width: 100%;
                    display: flex;
                    gap: 0.5rem;
                }
                .service-list-item > div:last-child button {
                    flex: 1;
                    justify-content: center;
                }

                .user-booking-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }
                .user-booking-item-actions {
                    width: 100%;
                    display: flex;
                    gap: 0.5rem;
                }
                .user-booking-item-actions button {
                    flex: 1;
                    justify-content: center;
                }
            }

            /* EXTRA ANIMATED THEME (design only, no feature changes) */
            body {
                background: radial-gradient(circle at 0% 0%, #eef2ff 0, transparent 55%),
                            radial-gradient(circle at 100% 0%, #ecfeff 0, transparent 55%),
                            radial-gradient(circle at 0% 100%, #fee2e2 0, transparent 55%),
                            radial-gradient(circle at 100% 100%, #fef9c3 0, transparent 55%),
                            linear-gradient(135deg, #eef2ff, #e0f2fe);
                background-size: 300% 300%;
                animation: bgGradient 18s ease-in-out infinite;
            }

            @keyframes bgGradient {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            /* Floating hero illustration */
            .hero-image {
                animation: float 7s ease-in-out infinite;
            }

            /* Glow + lift on important cards */
            .card,
            .feature-highlight,
            .popular-service-card,
            .user-dashboard-card,
            .service-management-card,
            .slot-management-card,
            .slots-list-container {
                position: relative;
                overflow: hidden;
            }

            .card::before,
            .feature-highlight::before,
            .popular-service-card::before,
            .user-dashboard-card::before,
            .service-management-card::before,
            .slot-management-card::before,
            .slots-list-container::before {
                content: "";
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle at 10% 0%, rgba(79, 70, 229, 0.18), transparent 60%);
                opacity: 0;
                transform: translate3d(0, 20px, 0);
                transition: opacity 0.4s ease, transform 0.4s ease;
                pointer-events: none;
            }

            .card:hover::before,
            .feature-highlight:hover::before,
            .popular-service-card:hover::before,
            .user-dashboard-card:hover::before,
            .service-management-card:hover::before,
            .slot-management-card:hover::before,
            .slots-list-container:hover::before {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }

            /* Soft breathing animation for primary CTA buttons */
            #main-auth-btn,
            #confirm-booking-btn,
            .btn-primary {
                animation: ctaPulse 2.8s ease-in-out infinite;
            }

            @keyframes ctaPulse {
                0%, 100% { transform: translateY(0) scale(1); box-shadow: 0 10px 25px rgba(79, 70, 229, 0.25); }
                50% { transform: translateY(-2px) scale(1.02); box-shadow: 0 18px 35px rgba(79, 70, 229, 0.35); }
            }

            /* Animated gradient ring behind user/admin avatar */
            #app-header-user .group > button,
            #app-header-admin .group > button {
                position: relative;
                z-index: 1;
            }

            #app-header-user .group,
            #app-header-admin .group {
                position: relative;
            }

            #app-header-user .group::before,
            #app-header-admin .group::before {
                content: "";
                position: absolute;
                inset: -3px;
                border-radius: 9999px;
                background: conic-gradient(from 180deg, #4f46e5, #a855f7, #22c55e, #4f46e5);
                opacity: 0;
                filter: blur(4px);
                transition: opacity 0.3s ease;
            }

            #app-header-user .group:hover::before,
            #app-header-admin .group:hover::before {
                opacity: 1;
                animation: spinRing 6s linear infinite;
            }

            @keyframes spinRing {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Subtle entrance animation for main views */
            #user-dashboard,
            #user-bookings,
            #slots-view,
            #admin-dashboard {
                animation: viewFadeIn 0.7s ease-out;
            }

            @keyframes viewFadeIn {
                0% { opacity: 0; transform: translateY(18px); }
                100% { opacity: 1; transform: translateY(0); }
            }
        </style>
    </head>
    <body class="antialiased">

        <div id="app" class="min-h-screen w-full">

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="view fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50" style="display: flex;">
                <div class="loading-spinner"></div>
            </div>

            <!-- Custom Message Box -->
            <div id="message-box-overlay" class="message-box-overlay">
                <div class="message-box">
                    <h3 id="message-box-title" class="message-box-title">Title</h3>
                    <p id="message-box-content" class="message-box-content">Message goes here.</p>
                    <div class="message-box-buttons">
                        <button id="message-box-ok" class="btn-primary">OK</button>
                        <button id="message-box-cancel" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Auth View -->
            <div id="auth-view" class="view w-full hero-bg">
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white/10 backdrop-blur-lg p-8 rounded-2xl shadow-2xl border border-white/20 animate-fade-in-down">
                        <div class="text-center mb-8">
                            <h1 id="auth-title" class="text-4xl font-bold text-white">Welcome Back</h1>
                            <p class="text-gray-300 mt-2">Your seamless scheduling solution.</p>
                        </div>
                        
                        <div id="auth-error" class="hidden bg-red-500/50 border border-red-500 text-white p-3 rounded-lg mb-4" role="alert">
                            <p class="font-bold text-sm" id="auth-error-message"></p>
                        </div>

                        <form id="auth-form" class="space-y-6">
                            <div id="register-form-fields" class="hidden space-y-6 overflow-hidden">
                                <div class="relative form-group">
                                    <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="name" class="auth-input" placeholder=" ">
                                    <label for="name" class="auth-label">Full Name</label>
                                </div>
                                <div class="relative form-group">
                                    <i class="fas fa-phone absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="tel" id="phone" class="auth-input" placeholder=" ">
                                    <label for="phone" class="auth-label">Phone Number</label>
                                </div>
                                <div class="relative form-group">
                                    <i class="fas fa-map-pin absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="place" class="auth-input" placeholder=" ">
                                    <label for="place" class="auth-label">City / Place</label>
                                </div>
                            </div>
                            
                            <div class="relative form-group">
                                <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="email" id="email" class="auth-input" required placeholder=" ">
                                <label for="email" class="auth-label">Email Address</label>
                            </div>
                            <div class="relative form-group">
                                <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="password" id="password" class="auth-input" required placeholder=" ">
                                <label for="password" class="auth-label">Password</label>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-300 mb-2">I am a:</label>
                                <div class="flex items-center justify-around bg-black/20 p-1 rounded-lg">
                                    <label class="w-1/2 text-center py-2 rounded-lg cursor-pointer text-gray-300 has-[:checked]:bg-indigo-600 has-[:checked]:text-white has-[:checked]:shadow-lg transition-all duration-300">
                                        <input type="radio" name="role" value="user" class="sr-only" checked> User
                                    </label>
                                    <label class="w-1/2 text-center py-2 rounded-lg cursor-pointer text-gray-300 has-[:checked]:bg-indigo-600 has-[:checked]:text-white has-[:checked]:shadow-lg transition-all duration-300">
                                        <input type="radio" name="role" value="admin" class="sr-only"> Administrator
                                    </label>
                                </div>
                            </div>

                            <div class="pt-2">
                                <button type="submit" id="main-auth-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-4 rounded-lg font-semibold text-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transform hover:-translate-y-1 transition-all duration-300 shadow-lg">
                                    Sign In
                                </button>
                            </div>
                        </form>

                        <div class="mt-8">
                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-500"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-gray-800/50 text-gray-400 backdrop-blur-sm rounded-full">Or continue with</span>
                                </div>
                            </div>
                            <div class="mt-6 grid grid-cols-2 gap-4">
                                <button class="w-full flex items-center justify-center py-2 px-4 text-sm font-medium text-white bg-white/10 border border-white/20 rounded-md shadow-sm hover:bg-white/20 transition-colors duration-300">
                                    <i class="fab fa-google mr-2"></i> Google
                                </button>
                                <button class="w-full flex items-center justify-center py-2 px-4 text-sm font-medium text-white bg-white/10 border border-white/20 rounded-md shadow-sm hover:bg-white/20 transition-colors duration-300">
                                    <i class="fab fa-apple mr-2"></i> Apple
                                </button>
                            </div>
                        </div>

                        <p class="mt-8 text-center text-sm text-gray-300">
                            <span id="auth-toggle-text">Don't have an account?</span>
                            <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-400 hover:text-indigo-300 transition-colors">Create one</a>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- App Header - User -->
            <header class="app-header sticky top-0 z-30 hidden shadow-sm" id="app-header-user">
                <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="text-2xl font-bold text-indigo-600 flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i> SwiftMeet
                        </div>
                        <div class="ml-10 hidden md:flex space-x-6">
                            <a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors nav-link" data-view="user-dashboard">Dashboard</a>
                            <a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors nav-link" data-view="user-bookings">My Bookings</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="relative mr-4">
                            <i class="fas fa-bell text-gray-500 text-xl cursor-pointer hover:text-indigo-600 transition-colors"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
                        </div>
                        <span id="user-name-display" class="text-gray-600 mr-4 font-semibold hidden md:inline"></span>
                        <div class="relative group">
                            <button class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold cursor-pointer">
                                <span id="user-initials">U</span>
                            </button>
                            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-40 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300">
                                <button class="w-full text-left block px-4 py-2 text-gray-800 hover:bg-indigo-50 hover:text-indigo-600 transition-colors" id="edit-profile-btn">
                                    <i class="fas fa-user-edit mr-2"></i>Edit Profile
                                </button>
                                <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                                    <i class="fas fa-cog mr-2"></i>Settings
                                </a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <button id="logout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            </header>

            <!-- App Header - Admin -->
            <header class="app-header sticky top-0 z-30 hidden shadow-sm" id="app-header-admin">
                <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="text-2xl font-bold text-indigo-600 flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i> SwiftMeet Admin
                        </div>
                        <div class="ml-10 hidden md:flex space-x-6">
                            <a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors nav-link" data-view="admin-dashboard">Dashboard</a>
                            <a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors nav-link" data-view="admin-services">Services</a>
                            <a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors nav-link" data-view="admin-slots">Slots</a>
                            <a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors nav-link" data-view="admin-bookings">Bookings</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="admin-name-display" class="text-gray-600 mr-4 font-semibold hidden md:inline"></span>
                        <div class="relative group">
                            <button class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold cursor-pointer">
                                <span id="admin-initials">A</span>
                            </button>
                            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-40 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300">
                                <button class="w-full text-left block px-4 py-2 text-gray-800 hover:bg-indigo-50 hover:text-indigo-600 transition-colors" id="admin-edit-profile-btn">
                                    <i class="fas fa-user-edit mr-2"></i>Edit Profile
                                </button>
                                <button id="logout-btn-admin" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            </header>

            <!-- User Dashboard View -->
            <div id="user-dashboard" class="view w-full">
                <!-- Hero Section -->
                <div class="hero-section">
                    <div class="container mx-auto px-6">
                        <div class="flex flex-col md:flex-row items-center justify-between">
                            <div class="md:w-1/2 mb-10 md:mb-0">
                                <h1 class="text-4xl md:text-5xl font-bold mb-4">Book Appointments in Seconds</h1>
                                <p class="text-xl text-indigo-100 mb-8">Find the best service providers near you and book appointments with AI-powered recommendations.</p>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <button class="bg-white text-indigo-600 py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-100 transition-all duration-300 shadow-lg flex items-center justify-center" id="how-it-works-btn">
                                        <i class="fas fa-play-circle mr-2"></i> How It Works
                                    </button>
                                    <button class="bg-transparent border-2 border-white text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-white hover:text-indigo-600 transition-all duration-300 flex items-center justify-center" id="learn-more-btn">
                                        <i class="fas fa-info-circle mr-2"></i> Learn More
                                    </button>
                                </div>
                            </div>
                            <div class="md:w-1/2 relative">
                                <!-- Updated hero image: appointment / calendar themed, with fallback -->
                                <img 
                                    src="https://images.unsplash.com/photo-1545239351-1141bd82e8a6?q=80&w=1400&auto=format&fit=crop" 
                                    alt="Calendar and appointments" 
                                    class="hero-image"
                                    loading="lazy"
                                    onerror="this.onerror=null;this.src='https://images.pexels.com/photos/118743/pexels-photo-118743.jpeg?auto=compress&cs=tinysrgb&w=1400';"
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Section -->
                <div class="container mx-auto px-6 -mt-10 md:-mt-16 relative z-10">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg card">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Find Your Perfect Slot</h2>
                                <p class="text-gray-500 mt-1">Search for a service and we'll find the best options near you</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <span class="badge badge-primary pulse">
                                    <i class="fas fa-bolt mr-1"></i> AI-Powered Suggestions
                                </span>
                            </div>
                        </div>
                        
                        <form id="find-service-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="md:col-span-2">
                                <label for="search-service-type" class="block text-sm font-medium text-gray-700 mb-1">Service Type</label>
                                <div class="relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="search-service-type" placeholder="What service are you looking for?" class="w-full pl-12 pr-4 py-3 form-input" required>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="user-location" class="block text-sm font-medium text-gray-700 mb-1">Your Location</label>
                                <div class="location-input-container">
                                    <i class="fas fa-map-marker-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="user-location" placeholder="Enter your location or use current" class="w-full pl-12 pr-12 py-3 form-input">
                                    <button type="button" id="current-location-btn" class="current-location-btn" title="Use current location">
                                        <i class="fas fa-crosshairs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="md:col-span-1">
                                <button type="submit" class="w-full btn-primary text-white py-3 px-5 rounded-lg font-semibold flex items-center justify-center gap-2 h-[52px]">
                                    <i class="fas fa-search"></i> Find
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- How It Works Section (NEW) -->
                <div id="how-it-works-section" class="container mx-auto px-6 py-16">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">How It Works</h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">Booking your next appointment is as easy as 1-2-3.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="text-center p-6">
                            <div class="text-5xl font-bold text-indigo-200 mb-4">1</div>
                            <div class="feature-icon-large mx-auto">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 my-3">Search</h3>
                            <p class="text-gray-600">Enter the service you need and your location. Our AI finds the best matches near you.</p>
                        </div>
                        <div class="text-center p-6">
                            <div class="text-5xl font-bold text-indigo-200 mb-4">2</div>
                            <div class="feature-icon-large mx-auto">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 my-3">Select</h3>
                            <p class="text-gray-600">Choose from AI-recommended slots or browse all available times. We factor in traffic and travel time.</p>
                        </div>
                        <div class="text-center p-6">
                            <div class="text-5xl font-bold text-indigo-200 mb-4">3</div>
                            <div class="feature-icon-large mx-auto">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 my-3">Confirm</h3>
                            <p class="text-gray-600">Book instantly and get your confirmation. We'll even tell you when to leave!</p>
                        </div>
                    </div>
                </div>

                <!-- Features Section -->
                <div id="features-section" class="container mx-auto px-6 py-16 bg-white rounded-3xl">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Why Choose SwiftMeet?</h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">Our platform makes appointment booking simple, fast, and intelligent with cutting-edge features.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- MODIFIED: Replaced icons with more attractive images -->
                        <div class="feature-highlight">
                            <img 
                                src="https://images.unsplash.com/photo-1677442136756-c095e6d338f0?q=80&w=600&auto=format&fit=crop" 
                                alt="AI Recommendations" 
                                class="feature-image"
                                loading="lazy"
                                onerror="this.onerror=null;this.src='https://images.pexels.com/photos/1181675/pexels-photo-1181675.jpeg?auto=compress&cs=tinysrgb&w=800';"
                            >
                            <h3 class="text-xl font-bold text-gray-800 mb-3">AI-Powered Recommendations</h3>
                            <p class="text-gray-600">Get smart suggestions based on your location, traffic conditions, and service availability.</p>
                        </div>
                        
                        <div class="feature-highlight">
                            <img 
                                src="https://images.unsplash.com/photo-1556742044-53c8dcb3a1ee?q=80&w=600&auto=format&fit=crop" 
                                alt="Instant Booking" 
                                class="feature-image"
                                loading="lazy"
                                onerror="this.onerror=null;this.src='https://images.pexels.com/photos/373882/pexels-photo-373882.jpeg?auto=compress&cs=tinysrgb&w=800';"
                            >
                            <h3 class="text-xl font-bold text-gray-800 mb-3">Instant Booking</h3>
                            <p class="text-gray-600">Book appointments in seconds with our streamlined process and instant confirmation.</p>
                        </div>
                        
                        <div class="feature-highlight">
                            <img 
                                src="https://images.unsplash.com/photo-1549880181-56a44cf4a9a5?q=80&w=600&auto=format&fit=crop" 
                                alt="Real-Time Navigation" 
                                class="feature-image"
                                loading="lazy"
                                onerror="this.onerror=null;this.src='https://images.pexels.com/photos/1720741/pexels-photo-1720741.jpeg?auto=compress&cs=tinysrgb&w=800';"
                            >
                            <h3 class="text-xl font-bold text-gray-800 mb-3">Real-Time Navigation</h3>
                            <p class="text-gray-600">Get accurate travel times with live traffic data and optimal route suggestions.</p>
                        </div>
                    </div>
                </div>

                <!-- Popular Services -->
                <div class="container mx-auto px-6 py-16">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Popular Services</h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">Browse through our most booked service categories</p>
                    </div>
                    
                    <!-- MODIFIED: More attractive service cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="popular-service-card" data-service="Hospital">
                            <div class="service-icon service-icon-hospital">
                                <i class="fas fa-stethoscope"></i>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Doctors</h3>
                        </div>
                        
                        <div class="popular-service-card" data-service="Salon">
                            <div class="service-icon service-icon-salon">
                                <i class="fas fa-spa"></i>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Salons</h3>
                        </div>
                        
                        <div class="popular-service-card" data-service="Gym">
                            <div class="service-icon service-icon-gym">
                                <i class="fas fa-dumbbell"></i>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Gyms</h3>
                        </div>
                        
                        <div class="popular-service-card" data-service="Restaurant">
                            <div class="service-icon service-icon-restaurant">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Restaurants</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Bookings View -->
            <div id="user-bookings" class="view w-full">
                <div class="container mx-auto p-6">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">My Bookings</h1>
                        <p class="text-gray-600">View and manage your upcoming and past appointments</p>
                    </div>
                    
                    <div class="user-dashboard-card">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">Your Appointments</h2>
                            <div class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-info-circle mr-2 text-indigo-500"></i>
                                <span>Click on an appointment to view details</span>
                            </div>
                        </div>
                        
                        <div id="user-bookings-list" class="space-y-4">
                            <!-- User bookings will be loaded here -->
                        </div>
                        
                        <div id="no-bookings-message" class="text-center py-12 hidden">
                            <i class="fas fa-calendar-times text-gray-300 text-5xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">No Bookings Yet</h3>
                            <p class="text-gray-500">You haven't booked any appointments yet. Start by searching for services.</p>
                            <button class="mt-4 btn-primary text-white py-2 px-4 rounded-lg font-semibold flex items-center mx-auto" id="find-services-from-bookings-btn">
                                <i class="fas fa-search mr-2"></i> Find Services
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Slots Selection View -->
            <div id="slots-view" class="view w-full">
                <div class="container mx-auto p-6">
                    <!-- Enhanced Header Section -->
                    <div class="mb-8">
                        <button id="back-to-dashboard" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center mb-4 transition-all duration-300 hover:translate-x-[-4px]">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                        </button>
                        
                        <div class="service-info-panel slide-in-up">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-white mb-2" id="slots-service-name">Available Time Slots</h1>
                                    <p class="text-indigo-100" id="slots-service-address">Select a time slot that works best for you</p>
                                </div>
                                <div class="mt-4 md:mt-0">
                                    <span class="badge badge-accent pulse-gentle">
                                        <i class="fas fa-robot mr-1"></i> AI Optimized
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mt-4 flex items-center text-white">
                                <div class="flex items-center mr-6">
                                    <i class="fas fa-clock mr-2"></i>
                                    <span>Today's Availability</span>
                                </div>
                                <div class="progress-bar flex-1 max-w-md">
                                    <div class="progress-fill" style="width: 65%"></div>
                                </div>
                                <span class="ml-2 font-semibold">65%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div class="lg:col-span-3">
                            <div class="slots-list-container slide-in-up">
                                <!-- AI Suggested Slots Section -->
                                <div class="ai-suggested-slots">
                                    <div class="ai-suggested-header">
                                        <i class="fas fa-robot"></i>
                                        <h2 class="text-xl font-bold">AI Best Recommendation</h2>
                                    </div>
                                    <div id="ai-best-slot-container">
                                        <!-- AI best slot will be loaded here -->
                                    </div>
                                </div>
                                
                                <!-- All Available Slots Section -->
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-list-alt text-indigo-500 mr-2"></i>All Available Slots
                                    </h2>
                                    <div id="all-slots-container">
                                        <!-- All slots grouped by service will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Sidebar -->
                        <div class="lg:col-span-1">
                            <div class="card p-6 sticky top-24 slide-in-up">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-clipboard-check text-indigo-500 mr-2"></i>Booking Summary
                                </h3>
                                
                                <!-- Selected Slot Info -->
                                <div id="selected-slot-info" class="bg-gradient-to-br from-gray-50 to-gray-100 p-5 rounded-xl border border-gray-200 mb-6 hidden slide-in-up">
                                    <div class="text-center mb-4">
                                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-calendar-check text-indigo-600 text-xl"></i>
                                        </div>
                                        <h4 class="font-semibold text-gray-800 text-lg" id="selected-date">Slot Selected</h4>
                                        <p class="text-indigo-600 font-bold text-xl mt-1" id="selected-time">Choose a time</p>
                                    </div>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Service:</span>
                                            <span class="font-semibold text-gray-800" id="selected-service-name">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Location:</span>
                                            <span class="font-semibold text-gray-800 text-right" id="selected-service-address">-</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Travel Time Info -->
                                    <div id="travel-time-info" class="travel-time-info mt-4 slide-in-up hidden">
                                        <!-- Travel info will be populated by JS -->
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="space-y-3 mb-6">
                                    <button id="confirm-booking-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 hover:shadow-lg hover:translate-y-[-2px]" disabled>
                                        <i class="fas fa-lock mr-2"></i> Confirm Booking
                                    </button>
                                    
                                    <div class="quick-actions">
                                        <button class="quick-action-btn" id="summary-directions-btn">
                                            <i class="fas fa-directions mr-1"></i> Directions
                                        </button>
                                        <button class="quick-action-btn">
                                            <i class="fas fa-share-alt mr-1"></i> Share
                                        </button>
                                        <button class="quick-action-btn">
                                            <i class="fas fa-heart mr-1"></i> Save
                                        </button>
                                        <button class="quick-action-btn">
                                            <i class="fas fa-question mr-1"></i> Help
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- AI Recommendations -->
                                <div class="pt-4 border-t border-gray-200">
                                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                        <i class="fas fa-lightbulb text-amber-500 mr-2"></i>AI Insights
                                    </h4>
                                    <div id="ai-recommendations" class="space-y-3">
                                        <p class="text-sm text-gray-600">Select a slot to see AI insights.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard View -->
            <div id="admin-dashboard" class="view w-full">
                <div class="container mx-auto p-6">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Administrator Dashboard</h1>
                        <p class="text-gray-600">Manage your services and appointment slots</p>
                    </div>
                    
                    <!-- Admin Navigation -->
                    <div class="admin-nav">
                        <div class="flex flex-col md:flex-row md:space-x-4">
                            <button class="admin-nav-item active" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </button>
                            <button class="admin-nav-item" data-section="services">
                                <i class="fas fa-building"></i>
                                <span>Services</span>
                            </button>
                            <button class="admin-nav-item" data-section="slots">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Slots</span>
                            </button>
                            <button class="admin-nav-item" data-section="bookings">
                                <i class="fas fa-users"></i>
                                <span>Bookings</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dashboard Section -->
                    <div id="admin-dashboard-section" class="admin-content-section active">
                        <div class="dashboard-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="total-services">0</div>
                                <div class="stat-label">Total Services</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="available-slots">0</div>
                                <div class="stat-label">Available Slots</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="booked-today">0</div>
                                <div class="stat-label">Booked Today</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="pending-actions">0</div>
                                <div class="stat-label">Pending Actions</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="user-dashboard-card">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                                <div class="space-y-4">
                                    <!-- MODIFIED: Added IDs to make these buttons work -->
                                    <button id="quick-add-service-btn" class="w-full bg-indigo-100 text-indigo-700 py-3 rounded-lg font-semibold flex items-center justify-center hover:bg-indigo-200 transition">
                                        <i class="fas fa-plus-circle mr-2"></i> Add New Service
                                    </button>
                                    <button id="quick-manage-slots-btn" class="w-full bg-green-100 text-green-700 py-3 rounded-lg font-semibold flex items-center justify-center hover:bg-green-200 transition">
                                        <i class="fas fa-calendar-plus mr-2"></i> Manage Slots
                                    </button>
                                    <button class="w-full bg-blue-100 text-blue-700 py-3 rounded-lg font-semibold flex items-center justify-center hover:bg-blue-200 transition">
                                        <i class="fas fa-chart-bar mr-2"></i> View Analytics
                                    </button>
                                </div>
                            </div>
                            
                            <div class="user-dashboard-card">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h2>
                                <div id="admin-recent-activity" class="space-y-4">
                                    <!-- Activity will be loaded here -->
                                    <p class="text-sm text-gray-500">No recent activity.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Services Section -->
                    <div id="admin-services-section" class="admin-content-section">
                        <div class="service-management-card">
                            <h2 class="text-xl font-bold text-gray-800 mb-6">Add New Service</h2>
                            <form id="add-service-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="service-name" class="block text-sm font-medium text-gray-700 mb-1">Service Name</label>
                                        <input type="text" id="service-name" placeholder="e.g., City Hospital" class="w-full form-input" required>
                                    </div>
                                    <div>
                                        <label for="service-type" class="block text-sm font-medium text-gray-700 mb-1">Service Type</label>
                                        <input type="text" id="service-type" placeholder="e.g., Hospital, Salon, Gym" class="w-full form-input" required>
                                    </div>
                                </div>
                                <div id="specialty-container" class="hidden">
                                    <label for="specialty-input" class="block text-sm font-medium text-gray-700 mb-1">Department / Specialty</label>
                                    <input type="text" id="specialty-input" placeholder="e.g., Orthopedic" class="w-full form-input">
                                </div>
                                <div>
                                    <label for="service-address" class="block text-sm font-medium text-gray-700 mb-1">Full Address</label>
                                    <input type="text" id="service-address" placeholder="Enter complete address" class="w-full form-input" required>
                                </div>
                                <div>
                                    <label for="service-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea id="service-description" placeholder="Describe your service" class="w-full form-input" rows="3"></textarea>
                                </div>
                                <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-semibold flex items-center justify-center">
                                    <i class="fas fa-plus mr-2"></i> Add Service
                                </button>
                            </form>
                        </div>
                        
                        <div class="service-management-card">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Your Services</h2>
                                <button id="delete-all-services-btn" class="btn-danger text-sm py-2 px-3 flex items-center">
                                    <i class="fas fa-trash mr-1"></i> Delete All
                                </button>
                            </div>
                            <div id="admin-services-list" class="space-y-4">
                                <!-- Services will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Slots Section -->
                    <div id="admin-slots-section" class="admin-content-section">
                        <div class="slot-management-card">
                            <h2 class="text-xl font-bold text-gray-800 mb-6">Manage Time Slots</h2>
                            
                            <div class="mb-6">
                                <label for="select-service-for-slots" class="block text-sm font-medium text-gray-700 mb-2">Select Service</label>
                                <select id="select-service-for-slots" class="w-full form-input">
                                    <option value="">Choose a service</option>
                                    <!-- Services will be populated here -->
                                </select>
                            </div>
                            
                            <div id="slot-management-interface" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label for="slot-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                        <input type="date" id="slot-date" class="w-full form-input" required>
                                    </div>
                                    <div>
                                        <label for="slot-time" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                        <input type="time" id="slot-time" class="w-full form-input" required>
                                    </div>
                                </div>
                                
                                <button id="add-slot-btn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold flex items-center justify-center mb-6">
                                    <i class="fas fa-plus mr-2"></i> Add Time Slot
                                </button>
                                
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Current Slots</h3>
                                <div id="admin-slots-list" class="space-y-3">
                                    <!-- Slots will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bookings Section -->
                    <div id="admin-bookings-section" class="admin-content-section">
                        <div class="user-dashboard-card">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">All Bookings</h2>
                                <div class="flex items-center text-sm text-gray-500">
                                    <i class="fas fa-info-circle mr-2 text-indigo-500"></i>
                                    <span>Shows all booked slots made by users for your services.</span>
                                </div>
                            </div>
                            <div id="admin-bookings-list" class="space-y-4">
                                <!-- Admin bookings will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Modal -->
            <div id="receipt-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 hidden z-40">
                <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md transform transition-all">
                    <div id="receipt-content" class="p-8 text-gray-800">
                        <div class="text-center mb-6">
                            <svg class="checkmark mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>
                            <h2 class="text-3xl font-bold text-gray-900 mt-4 mb-2">Appointment Confirmed!</h2>
                            <p id="receipt-user-name" class="text-gray-500"></p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 space-y-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-500">SERVICE</label>
                                <p id="receipt-service-name" class="text-lg font-bold mt-1"></p>
                                <p id="receipt-service-address" class="text-sm text-gray-600 mt-1"></p>
                            </div>
                            <div class="border-t border-gray-200 pt-4">
                                <label class="text-sm font-semibold text-gray-500">DATE & TIME</label>
                                <p id="receipt-slot-time" class="text-lg font-bold mt-1"></p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                <label class="text-sm font-semibold text-indigo-700">TRAVEL SUGGESTION</label>
                                <p class="text-md font-bold text-indigo-700 mt-1">You should leave by <span id="receipt-leave-by"></span></p>
                                <p id="receipt-traffic-details" class="text-xs text-indigo-500 mt-1"></p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 rounded-b-2xl flex flex-col sm:flex-row gap-3">
                        <button id="get-directions-btn" class="flex-1 btn-primary text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2">
                            <i class="fas fa-directions"></i> Get Directions
                        </button>
                        <button id="download-receipt-btn" class="flex-1 btn-secondary text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button id="close-receipt-btn" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-600 transition">Close</button>
                    </div>
                </div>
            </div>

            <!-- NEW: Edit Profile Modal -->
            <div id="profile-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4 hidden z-40">
                <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md transform transition-all custom-scrollbar">
                    <form id="profile-form">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Edit Profile</h2>
                            
                            <div class="profile-image-container">
                                <img 
                                    src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=200&auto=format&fit=crop" 
                                    id="profile-modal-image" 
                                    class="profile-image"
                                    loading="lazy"
                                    onerror="this.onerror=null;this.src='https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=200';"
                                >
                                <label for="profile-image-upload-input" class="profile-image-upload">
                                    <i class="fas fa-camera"></i>
                                    <input type="file" id="profile-image-upload-input" class="hidden" accept="image/*">
                                </label>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label for="profile-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                    <input type="text" id="profile-name" class="w-full form-input" required>
                                </div>
                                <div>
                                    <label for="profile-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                    <input type="tel" id="profile-phone" class="w-full form-input" required>
                                </div>
                                <div>
                                    <label for="profile-place" class="block text-sm font-medium text-gray-700 mb-1">City / Place</label>
                                    <input type="text" id="profile-place" class="w-full form-input" required>
                                </div>
                            </div>

                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Update Credentials</h3>
                                <p class="text-sm text-gray-500 mb-4">Requires re-authentication. Leave fields blank to keep current credentials.</p>
                                <div>
                                    <label for="profile-email" class="block text-sm font-medium text-gray-700 mb-1">New Email</label>
                                    <input type="email" id="profile-email" class="w-full form-input" placeholder="Enter new email">
                                </div>
                                <div class="mt-4">
                                    <label for="profile-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                    <input type="password" id="profile-password" class="w-full form-input" placeholder="Enter new password">
                                </div>
                                <div class="mt-4">
                                    <label for="profile-current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password (Required)</label>
                                    <input type="password" id="profile-current-password" class="w-full form-input" placeholder="Enter current password">
                                </div>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50 rounded-b-2xl flex gap-3">
                            <button type="button" id="close-profile-modal-btn" class="w-1/2 bg-gray-200 text-gray-800 py-3 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button>
                            <button type="submit" class="w-1/2 btn-primary text-white py-3 px-4 rounded-lg font-semibold">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>

        <script type="module">
            // Import Firebase modules
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, updatePassword, updateEmail, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, deleteDoc, writeBatch, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

            // --- App Configuration ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiftmeet-default-v2';
            
            // Use a placeholder config if not provided
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : {
                    apiKey: "AIzaSyDSeKQ1vMXCaTbSXTm7ssOrIBCcLto1Tc8", // Using placeholder for local dev
                    authDomain: "swiftmeet-local.firebaseapp.com",
                    projectId: "swiftmeet-local",
                    storageBucket: "swiftmeet-local.appspot.com",
                    messagingSenderId: "483091101465",
                    appId: "1:483091101465:web:97654bda974bc138597788"
                };
            
            // --- Firebase Initialization ---
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // --- DOM Elements ---
            const views = { 
                auth: document.getElementById('auth-view'), 
                'user-dashboard': document.getElementById('user-dashboard'),
                'user-bookings': document.getElementById('user-bookings'),
                'admin-dashboard': document.getElementById('admin-dashboard'),
                slots: document.getElementById('slots-view'),
                loading: document.getElementById('loading-spinner') 
            };
            
            const appHeaderUser = document.getElementById('app-header-user');
            const appHeaderAdmin = document.getElementById('app-header-admin');
            const userNameDisplay = document.getElementById('user-name-display');
            const userInitials = document.getElementById('user-initials');
            const adminNameDisplay = document.getElementById('admin-name-display');
            const adminInitials = document.getElementById('admin-initials');
            const authError = document.getElementById('auth-error');
            const authErrorMessage = document.getElementById('auth-error-message');
            const receiptModal = document.getElementById('receipt-modal');
            const backToDashboardBtn = document.getElementById('back-to-dashboard');
            const selectedSlotInfo = document.getElementById('selected-slot-info');
            const confirmBookingBtn = document.getElementById('confirm-booking-btn');
            const currentLocationBtn = document.getElementById('current-location-btn');
            const userLocationInput = document.getElementById('user-location');
            const aiBestSlotContainer = document.getElementById('ai-best-slot-container');
            const allSlotsContainer = document.getElementById('all-slots-container');
            
            // Admin elements
            const adminNavItems = document.querySelectorAll('.admin-nav-item');
            const adminContentSections = document.querySelectorAll('.admin-content-section');
            const selectServiceForSlots = document.getElementById('select-service-for-slots');
            const slotManagementInterface = document.getElementById('slot-management-interface');
            const adminSlotsList = document.getElementById('admin-slots-list');
            const adminRecentActivity = document.getElementById('admin-recent-activity');
            const adminBookingsList = document.getElementById('admin-bookings-list');
            const quickAddServiceBtn = document.getElementById('quick-add-service-btn');
            const quickManageSlotsBtn = document.getElementById('quick-manage-slots-btn');

            // Profile Modal Elements
            const profileModal = document.getElementById('profile-modal');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const adminEditProfileBtn = document.getElementById('admin-edit-profile-btn');
            const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
            const profileForm = document.getElementById('profile-form');

            // Message Box Elements
            const messageBoxOverlay = document.getElementById('message-box-overlay');
            const messageBoxTitle = document.getElementById('message-box-title');
            const messageBoxContent = document.getElementById('message-box-content');
            const messageBoxOk = document.getElementById('message-box-ok');
            const messageBoxCancel = document.getElementById('message-box-cancel');

            // Keep userLocation in sync with the text field so we know when it changed
            userLocationInput.addEventListener('input', () => {
                if (userLocationInput.value !== lastUserLocationInputValue) {
                    userLocation = null;
                }
            });

            let currentUser = null;
            let currentUserDetails = {};
            let isRegistering = false;
            let selectedSlot = null;
            let userLocation = null;
            let allServices = [];
            let allSlots = [];
            let selectedServiceForSlots = null;
            let adminListeners = []; // To unsubscribe from listeners on logout
            let autoRescheduleInProgress = false; // NEW: tracks automatic rescheduling state
            // NEW: simple real-time polling timers
            let userBookingsInterval = null;
            let adminBookingsInterval = null;
            // NEW: track last synced location text to keep coords and input in sync
            let lastUserLocationInputValue = '';

            // --- Custom Alert/Confirm Box ---
            const showMessageBox = (title, content, type = 'alert') => {
                return new Promise((resolve) => {
                    messageBoxTitle.textContent = title;
                    messageBoxContent.textContent = content;
                    
                    messageBoxOk.style.display = 'inline-block';
                    messageBoxCancel.style.display = type === 'confirm' ? 'inline-block' : 'none';
                    
                    messageBoxOverlay.classList.add('visible');
                    
                    messageBoxOk.onclick = () => {
                        messageBoxOverlay.classList.remove('visible');
                        resolve(true);
                    };
                    
                    messageBoxCancel.onclick = () => {
                        messageBoxOverlay.classList.remove('visible');
                        resolve(false);
                    };
                });
            };

            // --- Main App Logic ---
            const showView = (viewName) => {
                // Clear any existing real-time polling intervals when switching views
                if (userBookingsInterval) {
                    clearInterval(userBookingsInterval);
                    userBookingsInterval = null;
                }
                if (adminBookingsInterval) {
                    clearInterval(adminBookingsInterval);
                    adminBookingsInterval = null;
                }

                Object.values(views).forEach(v => v.style.display = 'none');
                
                // Show appropriate header
                if (viewName.startsWith('admin-')) {
                    appHeaderUser.style.display = 'none';
                    appHeaderAdmin.style.display = 'block';
                    // Automatically select dashboard if no specific admin view is given
                    if (viewName === 'admin-dashboard') {
                        showAdminSection('dashboard');
                    } else if (viewName === 'admin-services') {
                        showAdminSection('services');
                    } else if (viewName === 'admin-slots') {
                        showAdminSection('slots');
                    } else if (viewName === 'admin-bookings') {
                        showAdminSection('bookings');
                    }
                    views['admin-dashboard'].style.display = 'block';
                } else if (viewName === 'user-dashboard' || viewName === 'user-bookings' || viewName === 'slots') {
                    appHeaderUser.style.display = 'block';
                    appHeaderAdmin.style.display = 'none';
                    if (views[viewName]) views[viewName].style.display = 'block';
                } else {
                    appHeaderUser.style.display = 'none';
                    appHeaderAdmin.style.display = 'none';
                    if (views[viewName]) views[viewName].style.display = 'block';
                }
                
                // Load data when views are shown
                if (viewName === 'user-bookings') {
                    // Load once; no polling so the list does not refresh continuously
                    loadUserBookings();
                } else if (viewName === 'admin-dashboard') {
                    loadAdminData();
                } else if (viewName === 'user-dashboard') {
                    // Reset search form
                    document.getElementById('find-service-form').reset();
                    userLocation = null;
                    lastUserLocationInputValue = '';
                }
            };

            const displayAuthError = (message) => {
                authErrorMessage.textContent = message;
                authError.style.display = 'block';
            };

            const getInitials = (name) => {
                if (!name) return 'U';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            };

            // Unsubscribe from all admin listeners
            const clearAdminListeners = () => {
                adminListeners.forEach(unsubscribe => unsubscribe());
                adminListeners = [];
            };

            onAuthStateChanged(auth, async (user) => {
                if (isRegistering) return;
                clearAdminListeners(); // Clear listeners on auth change

                if (user && !user.isAnonymous) {
                    currentUser = user;
                    const userDocRef = doc(db, `users`, user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        currentUserDetails = userDoc.data();
                        
                        const displayName = currentUserDetails.name || 'User';
                        const initials = getInitials(displayName);
                        
                        if (currentUserDetails.role === 'admin') {
                            adminNameDisplay.textContent = `Welcome, ${displayName}!`;
                            adminInitials.textContent = initials;
                            userNameDisplay.textContent = `Welcome, ${displayName}!`; // Also set user header
                            userInitials.textContent = initials;
                            showView('admin-dashboard');
                            loadAdminData(); // Main function to load all admin data
                        } else {
                            userNameDisplay.textContent = `Welcome, ${displayName}!`;
                            userInitials.textContent = initials;
                            showView('user-dashboard');
                        }
                        views.loading.style.display = 'none';
                    } else {
                        console.log("User document not found yet, waiting for registration to complete.");
                        // This can happen if registration is interrupted
                        views.loading.style.display = 'none';
                        showView('auth');
                    }
                } else {
                    currentUser = null;
                    currentUserDetails = {};
                    showView('auth');
                    views.loading.style.display = 'none';
                }
            });
            
            // Initial anonymous auth for Firebase access (if needed) or dev
            const initialAuth = async () => {
                try {
                    // This logic is for when __initial_auth_token is provided by Canvas
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // Fallback for local dev if no token is present
                        // await signInAnonymously(auth); 
                        // For this app, we want to force login, so we just show the auth view
                        console.log("No auth token, showing login screen.");
                        showView('auth');
                        views.loading.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Auth failed:", error);
                    showView('auth');
                    views.loading.style.display = 'none';
                }
            };
            initialAuth();

            // --- Navigation Event Listeners ---
            document.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) {
                    e.preventDefault();
                    const view = navLink.dataset.view;
                    if (view === 'admin-services') {
                        showView('admin-dashboard');
                        showAdminSection('services');
                    } else if (view === 'admin-slots') {
                        showView('admin-dashboard');
                        showAdminSection('slots');
                    } else {
                        showView(view);
                    }
                }
            });

            // Admin navigation
            const showAdminSection = (sectionId) => {
                adminNavItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.section === sectionId);
                });
                adminContentSections.forEach(section => {
                    section.classList.toggle('active', section.id === `admin-${sectionId}-section`);
                });
                // Load data for the shown section
                if (sectionId === 'services') {
                    loadAdminServices();
                    if (adminBookingsInterval) {
                        clearInterval(adminBookingsInterval);
                        adminBookingsInterval = null;
                    }
                } else if (sectionId === 'slots') {
                    populateServiceSelector();
                    if (adminBookingsInterval) {
                        clearInterval(adminBookingsInterval);
                        adminBookingsInterval = null;
                    }
                } else if (sectionId === 'bookings') {
                    loadAdminBookings();
                    // Simple polling to keep bookings real-time for admin
                    if (!adminBookingsInterval) {
                        adminBookingsInterval = setInterval(loadAdminBookings, 5000);
                    }
                } else {
                    if (adminBookingsInterval) {
                        clearInterval(adminBookingsInterval);
                        adminBookingsInterval = null;
                    }
                }
            };

            adminNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    showAdminSection(item.dataset.section);
                });
            });

            // --- Authentication Event Listeners ---
            const authForm = document.getElementById('auth-form');
            const authToggleLink = document.getElementById('auth-toggle-link');
            let isLoginMode = true;

            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = !isLoginMode;

                const registerFieldsContainer = document.getElementById('register-form-fields');
                const fieldsToAnimate = registerFieldsContainer.querySelectorAll('.form-group');

                if (isLoginMode) {
                    // --- Animate OUT the registration fields ---
                    registerFieldsContainer.classList.add('animate-slide-out-up');
                    
                    setTimeout(() => {
                        registerFieldsContainer.classList.add('hidden');
                        registerFieldsContainer.classList.remove('animate-slide-out-up');
                    }, 500); // Animation duration

                } else {
                    // --- Animate IN the registration fields ---
                    registerFieldsContainer.classList.remove('hidden');
                    registerFieldsContainer.classList.add('animate-slide-in-down');

                    setTimeout(() => {
                        registerFieldsContainer.classList.remove('animate-slide-in-down');
                    }, 500);
                }
                
                // Update text content
                document.getElementById('auth-title').textContent = isLoginMode ? 'Welcome Back' : 'Create an Account';
                document.getElementById('main-auth-btn').textContent = isLoginMode ? 'Sign In' : 'Create Account';
                document.getElementById('auth-toggle-text').textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
                document.getElementById('auth-toggle-link').textContent = isLoginMode ? "Create one" : "Sign In";
            });


            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                views.loading.style.display = 'flex';
                authError.style.display = 'none';

                if (isLoginMode) {
                    // Handle Login
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        displayAuthError(error.message);
                        views.loading.style.display = 'none';
                    }
                } else {
                    // Handle Registration
                    isRegistering = true;
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const name = document.getElementById('name').value;
                    const phone = document.getElementById('phone').value;
                    const place = document.getElementById('place').value;
                    const role = document.querySelector('input[name="role"]:checked').value;
                    
                    if (!email || !password || !name || !phone || !place) {
                        displayAuthError("All fields are required.");
                        views.loading.style.display = 'none';
                        isRegistering = false;
                        return;
                    }
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        
                        currentUser = userCredential.user;
                        currentUserDetails = { email, name, phone, place, role, createdAt: serverTimestamp() };

                        await setDoc(doc(db, "users", currentUser.uid), currentUserDetails);
                        
                        // No need to show view, onAuthStateChanged will handle it
                    } catch (error) {
                        displayAuthError(error.message);
                    } finally {
                        isRegistering = false;
                        views.loading.style.display = 'none';
                    }
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('logout-btn-admin').addEventListener('click', () => signOut(auth));

            // --- NEW: Edit Profile Modal Logic ---
            const openProfileModal = () => {
                if (!currentUserDetails) return;
                document.getElementById('profile-name').value = currentUserDetails.name || '';
                document.getElementById('profile-phone').value = currentUserDetails.phone || '';
                document.getElementById('profile-place').value = currentUserDetails.place || '';
                document.getElementById('profile-email').value = '';
                document.getElementById('profile-password').value = '';
                document.getElementById('profile-current-password').value = '';
                profileModal.style.display = 'flex';
            };

            editProfileBtn.addEventListener('click', openProfileModal);
            adminEditProfileBtn.addEventListener('click', openProfileModal);

            closeProfileModalBtn.addEventListener('click', () => {
                profileModal.style.display = 'none';
            });

            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                views.loading.style.display = 'flex';
                
                const user = auth.currentUser;
                if (!user) {
                    views.loading.style.display = 'none';
                    showMessageBox('Error', 'You are not logged in.');
                    return;
                }

                // 1. Update basic profile info in Firestore
                const newName = document.getElementById('profile-name').value;
                const newPhone = document.getElementById('profile-phone').value;
                const newPlace = document.getElementById('profile-place').value;

                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    await updateDoc(userDocRef, {
                        name: newName,
                        phone: newPhone,
                        place: newPlace
                    });
                    
                    // Update local details
                    currentUserDetails.name = newName;
                    currentUserDetails.phone = newPhone;
                    currentUserDetails.place = newPlace;
                    
                    // Update UI
                    const initials = getInitials(newName);
                    userNameDisplay.textContent = `Welcome, ${newName}!`;
                    userInitials.textContent = initials;
                    adminNameDisplay.textContent = `Welcome, ${newName}!`;
                    adminInitials.textContent = initials;

                    // 2. Handle credential updates (Email/Password)
                    const newEmail = document.getElementById('profile-email').value.trim();
                    const newPassword = document.getElementById('profile-password').value.trim();
                    const currentPassword = document.getElementById('profile-current-password').value.trim();

                    if ((newEmail || newPassword) && !currentPassword) {
                        throw new Error("Please enter your current password to update email or password.");
                    }

                    if (currentPassword) {
                        const credential = EmailAuthProvider.credential(user.email, currentPassword);
                        await reauthenticateWithCredential(user, credential);
                        
                        if (newEmail && newEmail !== user.email) {
                            await updateEmail(user, newEmail);
                            // Also update email in Firestore
                            await updateDoc(userDocRef, { email: newEmail });
                            currentUserDetails.email = newEmail;
                        }
                        if (newPassword) {
                            await updatePassword(user, newPassword);
                        }
                    }

                    views.loading.style.display = 'none';
                    profileModal.style.display = 'none';
                    showMessageBox('Success', 'Profile updated successfully!');

                } catch (error) {
                    console.error("Profile update error:", error);
                    views.loading.style.display = 'none';
                    showMessageBox('Error', `Failed to update profile: ${error.message}`);
                }
            });

            // --- User Dashboard UI Listeners ---
            document.getElementById('learn-more-btn').addEventListener('click', () => {
                document.getElementById('features-section').scrollIntoView({ behavior: 'smooth' });
            });
            document.getElementById('how-it-works-btn').addEventListener('click', () => {
                document.getElementById('how-it-works-section').scrollIntoView({ behavior: 'smooth' });
            });
            document.getElementById('find-services-from-bookings-btn').addEventListener('click', () => {
                showView('user-dashboard');
            });

            // Popular services search
            document.querySelectorAll('.popular-service-card').forEach(card => {
                card.addEventListener('click', () => {
                    const service = card.dataset.service;
                    document.getElementById('search-service-type').value = service;
                    document.getElementById('find-service-form').dispatchEvent(new Event('submit', { cancelable: true }));
                });
            });


            // --- NEW: Current Location Feature ---
            currentLocationBtn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    showMessageBox('Error', 'Geolocation is not supported by this browser.');
                    return;
                }
                
                currentLocationBtn.classList.add('active');
                currentLocationBtn.disabled = true;
                views.loading.style.display = 'flex';
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const userCoords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Get address from coordinates
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ location: userCoords }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                userLocationInput.value = results[0].formatted_address;
                                userLocation = userCoords;
                            } else {
                                // Fallback: show raw coordinates if reverse geocoding fails
                                userLocationInput.value = `${userCoords.lat.toFixed(6)}, ${userCoords.lng.toFixed(6)}`;
                                userLocation = userCoords;
                            }
                            // Remember the last value that matches our stored coordinates
                            lastUserLocationInputValue = userLocationInput.value;
                            currentLocationBtn.classList.remove('active');
                            currentLocationBtn.disabled = false;
                            views.loading.style.display = 'none';
                        });
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        showMessageBox('Error', 'Unable to retrieve your location. Please enter it manually.');
                        currentLocationBtn.classList.remove('active');
                        currentLocationBtn.disabled = false;
                        views.loading.style.display = 'none';
                    }
                );
            });

            // --- MODIFIED: Find Service Form Submission ---
            document.getElementById('find-service-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const serviceType = document.getElementById('search-service-type').value.trim();
                const userLocationQuery = userLocationInput.value.trim();

                if (!serviceType) {
                    showMessageBox('Info', "Please provide a service type (e.g., 'Hospital', 'Salon').");
                    return;
                }
                
                views.loading.style.display = 'flex';

                const processSearch = async (userCoords) => {
                    userLocation = userCoords; // Store user location for travel calculations
                    lastUserLocationInputValue = userLocationInput.value; // Keep text and coords in sync
                    await openSlotsView(serviceType, userCoords);
                };

                // Case 1: We already have coordinates that match the current input text
                if (userLocation && userLocationInput.value === lastUserLocationInputValue) {
                    processSearch(userLocation);
                }
                // Case 2: User typed or changed an address
                else if (userLocationQuery) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'address': userLocationQuery }, (results, status) => {
                        if (status !== 'OK' || !results[0]) {
                            showMessageBox('Error', 'Could not find the location you entered. Please try again.');
                            views.loading.style.display = 'none';
                            return;
                        }
                        const userCoords = {
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        };
                        processSearch(userCoords);
                    });
                } 
                // Case 3: No location input, try to get current location
                else {
                    if (!navigator.geolocation) {
                        showMessageBox('Info', 'Geolocation is not supported. Please enter a location manually.');
                        views.loading.style.display = 'none';
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userCoords = { 
                                lat: position.coords.latitude, 
                                lng: position.coords.longitude 
                            };
                            // Set the input value for user feedback
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ location: userCoords }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    userLocationInput.value = results[0].formatted_address;
                                    lastUserLocationInputValue = userLocationInput.value;
                                } else {
                                    userLocationInput.value = `${userCoords.lat.toFixed(6)}, ${userCoords.lng.toFixed(6)}`;
                                    lastUserLocationInputValue = userLocationInput.value;
                                }
                            });
                            processSearch(userCoords);
                        },
                        () => {
                            showMessageBox('Error', 'Unable to retrieve your location. Please allow location access or enter it manually.');
                            views.loading.style.display = 'none';
                        }
                    );
                }
            });

            // --- NEW: Enhanced Slots View Logic ---
            backToDashboardBtn.addEventListener('click', () => {
                showView('user-dashboard');
            });

            // Function to open slots view with all available slots
            const openSlotsView = async (serviceType, userCoords) => {
                // Reset selection
                selectedSlot = null;
                selectedSlotInfo.classList.add('hidden');
                confirmBookingBtn.disabled = true;
                document.getElementById('summary-directions-btn').disabled = true;
                
                // Hide travel time info
                document.getElementById('travel-time-info').classList.add('hidden');
                
                // Clear previous slots
                aiBestSlotContainer.innerHTML = '';
                allSlotsContainer.innerHTML = '';
                
                // Show the slots view with animation
                showView('slots');
                
                // Update the slots view header
                document.getElementById('slots-service-name').textContent = `Available Time Slots`;
                document.getElementById('slots-service-address').textContent = `Based on your search for "${serviceType}"`;
                
                // Load all available slots
                await loadAllSlots(serviceType, userCoords);
            };

            // Function to load all slots for a service type
            const loadAllSlots = async (serviceType, userCoords) => {
                views.loading.style.display = 'flex';
                
                // Get all services of the specified type
                const searchTermLowercase = serviceType.toLowerCase();
                const q = query(collection(db, "services"), where("type_tokens", "array-contains", searchTermLowercase));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    aiBestSlotContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-search text-gray-300 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">No Services Found</h3>
                            <p class="text-gray-500">No services found for "${serviceType}". Try a different search term.</p>
                        </div>
                    `;
                    views.loading.style.display = 'none';
                    return;
                }

                allServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Get all available slots for these services
                allSlots = [];
                const now = new Date();
                
                for (const service of allServices) {
                    // Query for future slots that are not booked
                    const slotsQuery = query(
                        collection(db, `services/${service.id}/slots`), 
                        where("booked", "==", false),
                        where("time", ">", now)
                    );
                    const slotsSnapshot = await getDocs(slotsQuery);
                    
                    slotsSnapshot.forEach(doc => {
                        const slot = doc.data();
                        allSlots.push({
                            ...slot,
                            slotId: doc.id,
                            service: service,
                            time: slot.time.toDate()
                        });
                    });
                }

                if (allSlots.length === 0) {
                    aiBestSlotContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-calendar-times text-gray-300 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">No Available Slots</h3>
                            <p class="text-gray-500">There are no available slots for "${serviceType}" at the moment.</p>
                        </div>
                    `;
                    views.loading.style.display = 'none';
                    return;
                }

                // Sort slots by time
                allSlots.sort((a, b) => a.time - b.time);
                
                // Calculate distances and travel times if user location is available
                if (userCoords) {
                    await calculateDistancesAndTravelTimes(allSlots, userCoords);
                }
                
                // Find and render the single best AI recommended slot
                renderAIBestSlot();
                
                // Render all available slots grouped by service
                renderAllSlotsByService();
                
                views.loading.style.display = 'none';
            };

            // Calculate distances and travel times for all slots
            const calculateDistancesAndTravelTimes = async (slots, userCoords) => {
                // Get unique service coordinates
                const uniqueCoordsMap = new Map();
                slots.forEach(slot => {
                    if (slot.service.coords) {
                        uniqueCoordsMap.set(slot.service.id, new google.maps.LatLng(slot.service.coords.lat, slot.service.coords.lng));
                    }
                });
                const destinations = Array.from(uniqueCoordsMap.values());
                const serviceIds = Array.from(uniqueCoordsMap.keys());

                if (destinations.length === 0) return;
                
                const distanceService = new google.maps.DistanceMatrixService();
                
                return new Promise((resolve) => {
                    distanceService.getDistanceMatrix({
                        origins: [userCoords],
                        destinations,
                        travelMode: 'DRIVING',
                        drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }
                    }, (response, status) => {
                        if (status === 'OK') {
                            const travelData = {};
                            response.rows[0].elements.forEach((result, i) => {
                                const serviceId = serviceIds[i];
                                if (result.status === 'OK') {
                                    travelData[serviceId] = {
                                        distance: result.distance.text,
                                        durationInTraffic: result.duration_in_traffic ? result.duration_in_traffic.text : result.duration.text,
                                        durationInTrafficValue: result.duration_in_traffic ? result.duration_in_traffic.value : result.duration.value,
                                        distanceValue: result.distance.value
                                    };
                                }
                            });
                            
                            // Assign travel data to all slots from the same service
                            slots.forEach(slot => {
                                if (travelData[slot.service.id]) {
                                    Object.assign(slot, travelData[slot.service.id]);
                                }
                            });
                        }
                        resolve();
                    });
                });
            };

            // Find and render the single best AI recommended slot
            const renderAIBestSlot = () => {
                if (allSlots.length === 0) return;
                
                // Find the best slot based on multiple factors
                let bestSlot = null;
                let bestScore = -Infinity;
                
                allSlots.forEach(slot => {
                    // Skip slots without travel data if location was provided
                    if (userLocation && !slot.distanceValue) return;

                    let score = 0;
                    
                    // Factor 1: Proximity (closer is better) - High weight
                    if (slot.distanceValue) {
                        score -= slot.distanceValue * 0.5; // Penalize distance
                    }
                    
                    // Factor 2: Time of day (morning slots are preferred)
                    const hour = slot.time.getHours();
                    if (hour >= 9 && hour <= 11) {
                        score += 3000; // Morning bonus (scaled to match distance penalty)
                    } else if (hour >= 14 && hour <= 16) {
                        score += 2000; // Afternoon bonus
                    }
                    
                    // Factor 3: Date (sooner is better)
                    const now = new Date();
                    const timeDiff = slot.time - now;
                    const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
                    if (daysDiff <= 7) {
                        score += (7 - daysDiff) * 1000; // Higher score for sooner appointments
                    }
                    
                    // Factor 4: Travel time (shorter is better) - High weight
                    if (slot.durationInTrafficValue) {
                        score -= slot.durationInTrafficValue * 0.8; // Penalize travel time
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestSlot = slot;
                    }
                });

                // If no slot scored (e.g., no travel data), pick the first one
                if (!bestSlot) {
                    bestSlot = allSlots[0];
                }
                
                // Render the best slot
                aiBestSlotContainer.innerHTML = `
                    <div class="service-card p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800">${bestSlot.service.name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="badge badge-primary text-xs">${bestSlot.service.type}</span>
                                    <span class="badge badge-accent text-xs ml-2">
                                        <i class="fas fa-robot mr-1"></i> Best Match
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-600 mb-3">
                            <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                            <span class="truncate">${bestSlot.service.address}</span>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg mb-3 border border-blue-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-blue-800">${bestSlot.time.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })}</span>
                                <span class="font-bold text-blue-800 text-lg">${bestSlot.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div class="traffic-details">
                                <div class="traffic-details-row">
                                    <span class="traffic-label">Distance:</span>
                                    <span class="traffic-value">${bestSlot.distance || 'N/A'}</span>
                                </div>
                                <div class="traffic-details-row">
                                    <span class="traffic-label">Travel Time:</span>
                                    <span class="traffic-value">${bestSlot.durationInTraffic || 'N/A'}</span>
                                </div>
                                <div class="distance-details">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Best option based on distance, timing, and availability</span>
                                </div>
                            </div>
                        </div>
                        <button class="select-best-slot-btn w-full btn-primary text-white py-3 rounded-lg font-semibold flex items-center justify-center" 
                                data-service-id="${bestSlot.service.id}" 
                                data-slot-id="${bestSlot.slotId}">
                            <i class="fas fa-calendar-check mr-2"></i> Book This Slot
                        </button>
                    </div>
                `;
                
                // Add event listener to select the best slot
                document.querySelector('.select-best-slot-btn').addEventListener('click', (e) => {
                    const serviceId = e.target.closest('.select-best-slot-btn').dataset.serviceId;
                    const slotId = e.target.closest('.select-best-slot-btn').dataset.slotId;
                    
                    const slot = allSlots.find(s => s.slotId === slotId && s.service.id === serviceId);
                    if (slot) {
                        selectSlot(slot, e.target.closest('.service-card'));
                    }
                });
            };

            // Render all slots grouped by service
            const renderAllSlotsByService = () => {
                if (allSlots.length === 0) return;
                
                // Group slots by service
                const slotsByService = {};
                allSlots.forEach(slot => {
                    if (!slotsByService[slot.service.id]) {
                        slotsByService[slot.service.id] = {
                            service: slot.service,
                            slots: []
                        };
                    }
                    slotsByService[slot.service.id].slots.push(slot);
                });
                
                allSlotsContainer.innerHTML = '';
                
                Object.values(slotsByService).forEach((serviceGroup, index) => {
                    const serviceElement = document.createElement('div');
                    serviceElement.className = 'service-slots-group';
                    
                    const serviceHeader = document.createElement('div');
                    serviceHeader.className = 'service-slots-header';
                    serviceHeader.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg truncate">${serviceGroup.service.name}</h3>
                            <p class="text-sm text-gray-500 mt-1 truncate">${serviceGroup.service.address}</p>
                            ${userLocation ? `<p class="text-sm font-medium text-indigo-600 mt-1">${serviceGroup.slots[0].distance || 'N/A'} - ${serviceGroup.slots[0].durationInTraffic || 'N/A'} travel</p>` : ''}
                        </div>
                        <div class="text-right ml-4 flex-shrink-0">
                            <span class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-full">${serviceGroup.slots.length} slots</span>
                            <i class="fas fa-chevron-down ml-2 transition-transform"></i>
                        </div>
                    `;
                    
                    const serviceContent = document.createElement('div');
                    serviceContent.className = 'service-slots-content';
                    
                    // Group slots by day
                    const slotsByDay = {};
                    serviceGroup.slots.forEach(slot => {
                        const dateKey = slot.time.toDateString();
                        if (!slotsByDay[dateKey]) {
                            slotsByDay[dateKey] = [];
                        }
                        slotsByDay[dateKey].push(slot);
                    });
                    
                    Object.keys(slotsByDay).sort((a,b) => new Date(a) - new Date(b)).forEach(dateKey => {
                        const daySlots = slotsByDay[dateKey];
                        const date = daySlots[0].time;
                        
                        const dayGroup = document.createElement('div');
                        dayGroup.className = 'mb-4';
                        
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'flex justify-between items-center mb-3';
                        dayHeader.innerHTML = `
                            <h4 class="font-semibold text-gray-800">${date.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })}</h4>
                            <span class="text-sm text-gray-500">${daySlots.length} slots</span>
                        `;
                        
                        const slotsGrid = document.createElement('div');
                        slotsGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3';
                        
                        daySlots.sort((a,b) => a.time - b.time).forEach(slot => {
                            const slotElement = document.createElement('div');
                            slotElement.className = 'time-slot';
                            slotElement.innerHTML = `
                                <div class="slot-time">${slot.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                <div class="slot-availability">Available</div>
                            `;
                            
                            slotElement.addEventListener('click', () => {
                                selectSlot(slot, slotElement);
                            });
                            
                            slotsGrid.appendChild(slotElement);
                        });
                        
                        dayGroup.appendChild(dayHeader);
                        dayGroup.appendChild(slotsGrid);
                        serviceContent.appendChild(dayGroup);
                    });
                    
                    serviceHeader.addEventListener('click', () => {
                        serviceContent.classList.toggle('active');
                        const icon = serviceHeader.querySelector('i');
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                        serviceHeader.classList.toggle('active');
                    });

                    // Open the first service by default
                    if (index === 0) {
                        serviceContent.classList.add('active');
                        serviceHeader.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
                        serviceHeader.classList.add('active');
                    }
                    
                    serviceElement.appendChild(serviceHeader);
                    serviceElement.appendChild(serviceContent);
                    allSlotsContainer.appendChild(serviceElement);
                });
            };

            // Handle slot selection
            const selectSlot = async (slot, slotElement) => {
                // Remove selection from all slots
                document.querySelectorAll('.time-slot.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelectorAll('.select-best-slot-btn').forEach(item => {
                    item.classList.remove('selected', 'bg-green-500');
                    item.innerHTML = '<i class="fas fa-calendar-check mr-2"></i> Book This Slot';
                });
                
                // Highlight selected slot
                if (slotElement.classList.contains('time-slot')) {
                    slotElement.classList.add('selected');
                } else if (slotElement.classList.contains('service-card')) {
                    // This is the AI Best Pick card
                    const btn = slotElement.querySelector('.select-best-slot-btn');
                    btn.classList.add('selected', 'bg-green-500');
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i> Selected';
                }
                
                // Update selected slot info
                selectedSlot = slot;
                document.getElementById('selected-date').textContent = slot.time.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
                document.getElementById('selected-time').textContent = slot.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('selected-service-name').textContent = slot.service.name;
                document.getElementById('selected-service-address').textContent = slot.service.address;
                
                // Show selection info and enable booking button
                selectedSlotInfo.classList.remove('hidden');
                confirmBookingBtn.disabled = false;
                document.getElementById('summary-directions-btn').disabled = false;
                
                // Calculate travel time if user location is available
                if (userLocation) {
                    const travelInfo = await calculateEnhancedTravelTime(slot.time, slot.service.coords);
                    if (travelInfo) {
                        updateTravelInfoUI(travelInfo);
                        // Store travel info for receipt
                        selectedSlot.travelInfo = travelInfo;
                    } else {
                        document.getElementById('travel-time-info').classList.add('hidden');
                    }
                } else {
                    document.getElementById('travel-time-info').classList.add('hidden');
                }

                // Update AI Insights
                updateAIInsights(slot);
            };

            // Handle directions button in summary
            document.getElementById('summary-directions-btn').addEventListener('click', () => {
                if (selectedSlot && selectedSlot.service) {
                    const address = selectedSlot.service.address;
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
                    window.open(url, '_blank');
                }
            });

            // --- MODIFIED: Enhanced Travel Planning ---
            const calculateEnhancedTravelTime = async (slotTime, serviceCoords) => {
                if (!userLocation || !serviceCoords) return null;
                
                try {
                    const distanceService = new google.maps.DistanceMatrixService();
                    
                    return new Promise((resolve) => {
                        distanceService.getDistanceMatrix({
                            origins: [new google.maps.LatLng(userLocation.lat, userLocation.lng)],
                            destinations: [new google.maps.LatLng(serviceCoords.lat, serviceCoords.lng)],
                            travelMode: 'DRIVING',
                            drivingOptions: { 
                                departureTime: new Date(), 
                                trafficModel: 'bestguess' 
                            },
                            unitSystem: google.maps.UnitSystem.METRIC
                        }, (response, status) => {
                            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                                const result = response.rows[0].elements[0];
                                const travelTimeInSeconds = result.duration_in_traffic ? result.duration_in_traffic.value : result.duration.value;
                                const travelTimeText = result.duration_in_traffic ? result.duration_in_traffic.text : result.duration.text;
                                const distanceText = result.distance.text;
                                
                                // Calculate departure and arrival times
                                const arrivalTime = new Date(slotTime);
                                const departureTime = new Date(arrivalTime.getTime() - (travelTimeInSeconds * 1000));
                                
                                // Generate traffic insights
                                const trafficInsights = generateTrafficInsights(travelTimeInSeconds, result.duration.value);
                                
                                resolve({
                                    travelTime: travelTimeInSeconds,
                                    travelTimeText,
                                    distanceText,
                                    departureTime,
                                    arrivalTime,
                                    trafficInsights
                                });
                            } else {
                                resolve(null);
                            }
                        });
                    });
                } catch (error) {
                    console.error("Error calculating travel time:", error);
                    return null;
                }
            };

            const generateTrafficInsights = (travelTimeWithTraffic, travelTimeWithoutTraffic) => {
                const trafficDelay = travelTimeWithTraffic - travelTimeWithoutTraffic;
                const delayMinutes = Math.round(trafficDelay / 60);
                
                if (delayMinutes <= 2) {
                    return {
                        level: 'light',
                        color: 'text-green-500',
                        message: 'Light traffic expected',
                        suggestion: 'Normal travel time'
                    };
                } else if (delayMinutes <= 10) {
                    return {
                        level: 'moderate',
                        color: 'text-yellow-500',
                        message: `Moderate traffic - ~${delayMinutes} min delay`,
                        suggestion: 'Consider leaving a bit earlier'
                    };
                } else {
                    return {
                        level: 'heavy',
                        color: 'text-red-500',
                        message: `Heavy traffic - ~${delayMinutes} min delay`,
                        suggestion: 'Leave significantly earlier'
                    };
                }
            };

            const updateTravelInfoUI = (travelInfo) => {
                const travelTimeInfo = document.getElementById('travel-time-info');
                
                let trafficHTML = '';
                if (travelInfo.trafficInsights) {
                    trafficHTML = `
                        <div class="travel-suggestion">
                            <div class="flex items-center mb-1">
                                <i class="fas fa-traffic-light ${travelInfo.trafficInsights.color} mr-2"></i>
                                <span class="font-medium">${travelInfo.trafficInsights.message}</span>
                            </div>
                            <p class="text-sm text-gray-600">${travelInfo.trafficInsights.suggestion}</p>
                        </div>
                    `;
                }
                
                travelTimeInfo.innerHTML = `
                    <div class="text-center mb-3">
                        <i class="fas fa-route text-blue-500 text-lg mb-1"></i>
                        <h5 class="font-semibold text-blue-800 text-sm">Travel Planning</h5>
                    </div>
                    <div class="travel-route-info">
                        <div>
                            <span class="travel-time-label">Distance:</span>
                            <span class="travel-time-value">${travelInfo.distanceText}</span>
                        </div>
                        <span class="travel-time-badge">${travelInfo.travelTimeText}</span>
                    </div>
                    <div class="travel-time-row">
                        <span class="travel-time-label">Depart By:</span>
                        <span class="travel-time-value">${travelInfo.departureTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    <div class="travel-time-row">
                        <span class="travel-time-label">Arrive By:</span>
                        <span class="travel-time-value">${travelInfo.arrivalTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    ${trafficHTML}
                `;
                
                travelTimeInfo.classList.remove('hidden');
            };

            const updateAIInsights = (slot) => {
                const container = document.getElementById('ai-recommendations');
                let insightsHTML = '';

                const hour = slot.time.getHours();
                if (hour >= 9 && hour <= 11) {
                    insightsHTML += `<p class="text-sm text-gray-600"><i class="fas fa-sun text-green-500 mr-2"></i>Good: This is a popular morning slot.</p>`;
                } else if (hour >= 18) {
                    insightsHTML += `<p class="text-sm text-gray-600"><i class="fas fa-moon text-yellow-500 mr-2"></i>Note: This is an evening slot, may have more traffic.</p>`;
                }

                if (slot.travelInfo && slot.travelInfo.trafficInsights.level !== 'light') {
                    insightsHTML += `<p class="text-sm text-gray-600"><i class="fas fa-traffic-light ${slot.travelInfo.trafficInsights.color} mr-2"></i>Traffic: ${slot.travelInfo.trafficInsights.message}.</p>`;
                }

                if (insightsHTML === '') {
                    insightsHTML = `<p class="text-sm text-gray-600">This looks like a standard slot. Enjoy your appointment!</p>`;
                }

                container.innerHTML = insightsHTML;
            };

            // --- MODIFIED: Enhanced Booking Confirmation ---
            const showBookingConfirmation = (serviceName, serviceAddress, slotTimeISO, travelInfo) => {
                const slotTime = new Date(slotTimeISO);
                document.getElementById('receipt-user-name').textContent = `For ${currentUserDetails.name}`;
                document.getElementById('receipt-service-name').textContent = serviceName;
                document.getElementById('receipt-service-address').textContent = serviceAddress;
                document.getElementById('receipt-slot-time').textContent = `${slotTime.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })} at ${slotTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                
                // Enhanced travel information
                if (travelInfo) {
                    document.getElementById('receipt-leave-by').textContent = travelInfo.departureTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('receipt-traffic-details').textContent = `Travel time: ${travelInfo.travelTimeText} (${travelInfo.distanceText})`;
                    
                    // Add traffic insight to receipt
                    if (travelInfo.trafficInsights) {
                        document.getElementById('receipt-traffic-details').textContent += ` - ${travelInfo.trafficInsights.message}`;
                    }
                } else {
                    document.getElementById('receipt-leave-by').textContent = "Unknown";
                    document.getElementById('receipt-traffic-details').textContent = "(Travel time could not be calculated)";
                }

                document.getElementById('get-directions-btn').dataset.address = serviceAddress;
                
                receiptModal.style.display = 'flex';
            };

            // Handle booking confirmation
            confirmBookingBtn.addEventListener('click', async () => {
                if (!selectedSlot) return;
                
                const confirmed = await showMessageBox('Confirm Booking', `Are you sure you want to book this appointment for ${selectedSlot.time.toLocaleString()}?`, 'confirm');
                
                if (confirmed) {
                    views.loading.style.display = 'flex';
                    const slotRef = doc(db, `services/${selectedSlot.service.id}/slots`, selectedSlot.slotId);
                    await updateDoc(slotRef, { 
                        booked: true, 
                        bookedBy: currentUser.uid,
                        bookedByName: currentUserDetails.name,
                        bookedAt: serverTimestamp(),
                        status: 'booked' // NEW: status field
                    });
                    
                    views.loading.style.display = 'none';
                    showBookingConfirmation(
                        selectedSlot.service.name, 
                        selectedSlot.service.address, 
                        selectedSlot.time.toISOString(), 
                        selectedSlot.travelInfo || null
                    );
                    showView('user-dashboard');
                }
            });

            // --- Administrator Logic ---
            
            // Main function to load all data and set up listeners
            const loadAdminData = () => {
                if (!currentUser || currentUserDetails.role !== 'admin') return;

                clearAdminListeners(); // Clear previous listeners
                updateAdminStats();
                loadAdminServices(); // This will be called but onSnapshot will keep it live
                populateServiceSelector(); // Same
                
                // Set up a listener for recent bookings to update stats and activity
                const bookingsQuery = query(
                    collection(db, "services"), 
                    where("adminId", "==", currentUser.uid)
                );
                
                const unsubscribeServices = onSnapshot(bookingsQuery, (servicesSnapshot) => {
                    let totalSlots = 0;
                    let pendingActions = 0;
                    let bookedToday = 0;
                    let recentActivities = [];

                    document.getElementById('total-services').textContent = servicesSnapshot.size;

                    if (servicesSnapshot.empty) {
                        document.getElementById('available-slots').textContent = 0;
                        document.getElementById('booked-today').textContent = 0;
                        document.getElementById('pending-actions').textContent = 0;
                        adminRecentActivity.innerHTML = '<p class="text-sm text-gray-500">No recent activity.</p>';
                        return;
                    }

                    const todayStart = new Date();
                    todayStart.setHours(0, 0, 0, 0);

                    const servicePromises = [];

                    servicesSnapshot.forEach((serviceDoc) => {
                        const service = serviceDoc.data();
                        const slotsQuery = query(collection(db, `services/${serviceDoc.id}/slots`));
                        
                        servicePromises.push(
                            getDocs(slotsQuery).then(slotsSnapshot => {
                                slotsSnapshot.forEach(slotDoc => {
                                    const slot = slotDoc.data();
                                    const slotTime = slot.time.toDate();

                                    if (!slot.booked) {
                                        totalSlots++;
                                    } else {
                                        if (slot.bookedAt && slot.bookedAt.toDate() >= todayStart) {
                                            bookedToday++;
                                        }
                                        // Add to recent activity
                                        recentActivities.push({
                                            time: slot.bookedAt ? slot.bookedAt.toDate() : new Date(),
                                            html: `
                                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                    <i class="fas fa-check text-green-600"></i>
                                                </div>
                                                <div>
                                                    <p class="font-semibold">${service.name}</p>
                                                    <p class="text-sm text-gray-500">New booking by ${slot.bookedByName || 'Unknown'}</p>
                                                </div>
                                            </div>
                                            `
                                        });
                                    }

                                    // Check for pending actions (e.g., no-shows from yesterday)
                                    if (slot.status === 'booked' && slotTime < todayStart && !slot.arrived) {
                                        pendingActions++;
                                    }
                                });
                            })
                        );
                    });

                    Promise.all(servicePromises).then(() => {
                        document.getElementById('available-slots').textContent = totalSlots;
                        document.getElementById('booked-today').textContent = bookedToday;
                        document.getElementById('pending-actions').textContent = pendingActions;
                        
                        // Render recent activity
                        if (recentActivities.length > 0) {
                            adminRecentActivity.innerHTML = recentActivities
                                .sort((a, b) => b.time - a.time) // Sort by time desc
                                .slice(0, 5) // Get top 5
                                .map(activity => activity.html)
                                .join('');
                        } else {
                            adminRecentActivity.innerHTML = '<p class="text-sm text-gray-500">No recent activity.</p>';
                        }
                    });
                });
                adminListeners.push(unsubscribeServices); // Add listener to array
            };


            // --- Admin Quick Action Buttons ---
            quickAddServiceBtn.addEventListener('click', () => {
                showAdminSection('services');
            });
            quickManageSlotsBtn.addEventListener('click', () => {
                showAdminSection('slots');
            });

            document.getElementById('service-type').addEventListener('change', (e) => {
                const specialtyContainer = document.getElementById('specialty-container');
                if (e.target.value.toLowerCase().trim() === 'hospital') {
                    specialtyContainer.style.display = 'block';
                } else {
                    specialtyContainer.style.display = 'none';
                }
            });

            document.getElementById('add-service-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                views.loading.style.display = 'flex';
                const address = document.getElementById('service-address').value;
                const serviceName = document.getElementById('service-name').value;
                const serviceTypeInput = document.getElementById('service-type').value;
                const isHospital = serviceTypeInput.toLowerCase().trim() === 'hospital';
                const specialtyInput = document.getElementById('specialty-input').value;
                const description = document.getElementById('service-description').value;

                // Create search tokens
                const finalServiceName = isHospital && specialtyInput ? `${serviceName} - ${specialtyInput}` : serviceName;
                const tokens = [
                    ...finalServiceName.toLowerCase().split(' ').filter(Boolean),
                    ...serviceTypeInput.toLowerCase().split(' ').filter(Boolean),
                    ...specialtyInput.toLowerCase().split(' ').filter(Boolean),
                    ...description.toLowerCase().split(' ').filter(Boolean)
                ];
                const typeTokens = [...new Set(tokens)]; // Unique tokens

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': address }, async (results, status) => {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        await addDoc(collection(db, "services"), {
                            adminId: currentUser.uid,
                            name: finalServiceName,
                            type: serviceTypeInput,
                            specialty: isHospital ? specialtyInput : null,
                            description: description,
                            type_tokens: typeTokens, // Use the new token field
                            address,
                            coords: { lat: location.lat(), lng: location.lng() },
                            createdAt: serverTimestamp()
                        });
                        e.target.reset();
                        views.loading.style.display = 'none';
                        showMessageBox('Success', 'Service added successfully!');
                        // Data will reload via onSnapshot listeners
                    } else {
                        views.loading.style.display = 'none';
                        showMessageBox('Error', 'Geocoding failed: ' + status);
                    }
                });
            });

            const loadAdminServices = () => {
                if (!currentUser) return;
                const q = query(collection(db, "services"), where("adminId", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = document.getElementById('admin-services-list');
                    list.innerHTML = '';
                    if(snapshot.empty) {
                        list.innerHTML = `
                            <div class="text-center py-12">
                                <i class="fas fa-building text-gray-300 text-5xl mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-700 mb-2">No Services Yet</h3>
                                <p class="text-gray-500 mb-4">Add your first service to get started</p>
                            </div>
                        `;
                        return;
                    }
                    snapshot.forEach((doc) => {
                        const service = doc.data();
                        list.innerHTML += `
                            <div class="service-list-item">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${service.name}</h3>
                                    <div class="flex items-center mt-1 flex-wrap gap-2">
                                        <span class="badge badge-primary text-xs">${service.type}</span>
                                        ${service.specialty ? `<span class="badge badge-secondary text-xs">${service.specialty}</span>` : ''}
                                    </div>
                                    <p class="text-sm text-gray-600 mt-2">${service.address}</p>
                                    ${service.description ? `<p class="text-sm text-gray-500 mt-1">${service.description}</p>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button data-id="${doc.id}" class="manage-service-slots-btn btn-secondary text-sm py-2 px-3 flex items-center">
                                        <i class="fas fa-calendar-alt mr-1"></i> Manage Slots
                                    </button>
                                    <button data-id="${doc.id}" class="delete-service-btn btn-danger text-sm py-2 px-3 flex items-center">
                                        <i class="fas fa-trash mr-1"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                });
                adminListeners.push(unsubscribe); // Add to listener array
            };

            // Event delegation for dynamically added buttons
            document.getElementById('admin-services-list').addEventListener('click', async (e) => {
                const manageBtn = e.target.closest('.manage-service-slots-btn');
                if (manageBtn) {
                    const serviceId = manageBtn.dataset.id;
                    showAdminSection('slots');
                    selectServiceForSlots.value = serviceId;
                    selectServiceForSlots.dispatchEvent(new Event('change'));
                    return;
                }
                
                const deleteBtn = e.target.closest('.delete-service-btn');
                if (deleteBtn) {
                    const serviceId = deleteBtn.dataset.id;
                    const confirmed = await showMessageBox('Delete Service', 'Are you sure you want to permanently delete this service and all its slots?', 'confirm');
                    
                    if (confirmed) {
                        views.loading.style.display = 'flex';
                        const serviceRef = doc(db, "services", serviceId);
                        
                        // Delete all slots in the subcollection
                        const slotsQuery = query(collection(serviceRef, 'slots'));
                        const slotsSnapshot = await getDocs(slotsQuery);
                        
                        const batch = writeBatch(db);
                        slotsSnapshot.forEach(slotDoc => {
                            batch.delete(slotDoc.ref);
                        });
                        await batch.commit();
                        
                        // Delete the service itself
                        await deleteDoc(serviceRef);
                        
                        views.loading.style.display = 'none';
                        showMessageBox('Success', 'Service deleted successfully.');
                        // Data reloads via onSnapshot
                    }
                }
            });


            // Populate service selector for slot management
            const populateServiceSelector = () => {
                if (!currentUser) return;
                const q = query(collection(db, "services"), where("adminId", "==", currentUser.uid));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const currentVal = selectServiceForSlots.value;
                    selectServiceForSlots.innerHTML = '<option value="">Choose a service</option>';
                    snapshot.forEach((doc) => {
                        const service = doc.data();
                        selectServiceForSlots.innerHTML += `
                            <option value="${doc.id}">${service.name}</option>
                        `;
                    });
                    // Preserve selection if possible
                    selectServiceForSlots.value = currentVal;
                });
                adminListeners.push(unsubscribe); // Add to listener array
            };

            let currentSlotListener = null; // To store the onSnapshot listener for slots

            // Handle service selection for slot management
            selectServiceForSlots.addEventListener('change', () => {
                const serviceId = selectServiceForSlots.value;
                // Unsubscribe from previous slot listener
                if (currentSlotListener) {
                    currentSlotListener();
                }
                
                if (serviceId) {
                    slotManagementInterface.classList.remove('hidden');
                    selectedServiceForSlots = serviceId;
                    loadServiceSlots(serviceId);
                } else {
                    slotManagementInterface.classList.add('hidden');
                    selectedServiceForSlots = null;
                    adminSlotsList.innerHTML = ''; // Clear list
                }
            });

            // Load slots for a specific service
            const loadServiceSlots = (serviceId) => {
                const q = query(collection(db, `services/${serviceId}/slots`));
                
                currentSlotListener = onSnapshot(q, (snapshot) => {
                    adminSlotsList.innerHTML = '';
                    if(snapshot.empty) {
                        adminSlotsList.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-calendar-times text-gray-300 text-4xl mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-700 mb-2">No Slots Added</h3>
                                <p class="text-gray-500">Add time slots for this service using the form above.</p>
                            </div>
                        `;
                        return;
                    }

                    let slots = [];
                    snapshot.forEach(doc => {
                        slots.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort slots by time
                    slots.sort((a, b) => a.time.toDate() - b.time.toDate());

                    const now = new Date();
                    slots.forEach((slot) => {
                        const slotTime = slot.time.toDate();
                        const statusLabel = slot.status || (slot.booked ? 'booked' : 'available');

                        const rightSideHtml = !slot.booked
                            ? `<button data-service-id="${serviceId}" data-slot-id="${slot.id}" class="delete-slot-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`
                            : '';

                        adminSlotsList.innerHTML += `
                            <div class="time-slot-management">
                                <div class="time-slot-management-header">
                                    <div>
                                        <span class="font-medium ${slot.booked ? 'text-red-600' : 'text-green-600'}">
                                            ${slotTime.toLocaleString()}
                                        </span>
                                        ${slot.booked ? `<p class="text-xs text-red-700 font-bold mt-1">Booked by: ${slot.bookedByName || 'Unknown'}</p>` : ''}
                                        ${slot.booked ? `<p class="text-[11px] text-gray-500 mt-1">Status: ${statusLabel}</p>` : ''}
                                    </div>
                                    ${rightSideHtml}
                                </div>
                            </div>
                        `;
                    });
                });
                adminListeners.push(currentSlotListener); // Add to main listener array
            };

            // Event delegation for deleting slots only
            adminSlotsList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-slot-btn');
                if (deleteBtn) {
                    const serviceId = deleteBtn.dataset.serviceId;
                    const slotId = deleteBtn.dataset.slotId;
                    const confirmed = await showMessageBox('Delete Slot', 'Are you sure you want to delete this slot?', 'confirm');
                    if(confirmed) {
                        await deleteDoc(doc(db, `services/${serviceId}/slots`, slotId));
                    }
                }
            });

            // Add slot button
            document.getElementById('add-slot-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                if (!selectedServiceForSlots) {
                    showMessageBox('Error', 'Please select a service first.');
                    return;
                }
                
                const slotDate = document.getElementById('slot-date').value;
                const slotTime = document.getElementById('slot-time').value;
                
                if(slotDate && slotTime) {
                    const combinedDateTime = new Date(`${slotDate}T${slotTime}`);
                    if (combinedDateTime < new Date()) {
                        showMessageBox('Error', 'Cannot add a slot in the past.');
                        return;
                    }
                    
                    await addDoc(collection(db, `services/${selectedServiceForSlots}/slots`), {
                        time: combinedDateTime,
                        booked: false,
                        bookedBy: null,
                        bookedByName: null,
                        status: 'available'
                    });
                    
                    // Clear the form
                    document.getElementById('slot-time').value = '';
                } else {
                    showMessageBox('Error', 'Please provide both date and time.');
                }
            });

            // Delete all services button
            document.getElementById('delete-all-services-btn').addEventListener('click', async () => {
                const confirmed = await showMessageBox('DANGER', 'This will delete ALL services for your account and all their slots. This cannot be undone. Are you sure?', 'confirm');
                
                if (confirmed) {
                    views.loading.style.display = 'flex';
                    const q = query(collection(db, "services"), where("adminId", "==", currentUser.uid));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        views.loading.style.display = 'none';
                        showMessageBox('Info', "No services to delete.");
                        return;
                    }
                    
                    for (const serviceDoc of snapshot.docs) {
                        // Delete all slots in subcollection
                        const slotsQuery = query(collection(serviceDoc.ref, 'slots'));
                        const slotsSnapshot = await getDocs(slotsQuery);
                        const batch = writeBatch(db);
                        slotsSnapshot.forEach(slotDoc => {
                            batch.delete(slotDoc.ref);
                        });
                        await batch.commit();
                        
                        // Delete the service doc
                        await deleteDoc(serviceDoc.ref);
                    }
                    
                    views.loading.style.display = 'none';
                    showMessageBox('Success', "All of your services have been deleted.");
                }
            });

            // Update admin dashboard stats (This is now part of the loadAdminData onSnapshot)
            const updateAdminStats = async () => {
            // This function is now superseded by the real-time listener in loadAdminData
            console.log("Updating stats (called by legacy function, handled by onSnapshot)");
            };

            // --- NEW: Admin Bookings View (all booked slots for admin services) ---
            const loadAdminBookings = async () => {
                if (!currentUser || currentUserDetails.role !== 'admin' || !adminBookingsList) return;

                adminBookingsList.innerHTML = '<div class="loading-spinner mx-auto"></div>';

                try {
                    // Get all services owned by this admin
                    const servicesSnapshot = await getDocs(
                        query(collection(db, "services"), where("adminId", "==", currentUser.uid))
                    );

                    if (servicesSnapshot.empty) {
                        adminBookingsList.innerHTML = '<p class="text-sm text-gray-500">No services found for this admin.</p>';
                        return;
                    }

                    const bookings = [];

                    for (const serviceDoc of servicesSnapshot.docs) {
                        const service = { id: serviceDoc.id, ...serviceDoc.data() };
                        const slotsSnapshot = await getDocs(
                            query(
                                collection(db, `services/${serviceDoc.id}/slots`),
                                where("booked", "==", true)
                            )
                        );

                        slotsSnapshot.forEach(slotDoc => {
                            const slot = slotDoc.data();
                            bookings.push({
                                slotId: slotDoc.id,
                                service,
                                ...slot
                            });
                        });
                    }

                    adminBookingsList.innerHTML = '';

                    if (bookings.length === 0) {
                        adminBookingsList.innerHTML = `
                            <div class="text-center py-12">
                                <i class="fas fa-calendar-times text-gray-300 text-4xl mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-700 mb-2">No Bookings Yet</h3>
                                <p class="text-gray-500">When users book your services, they will appear here.</p>
                            </div>
                        `;
                        return;
                    }

                    // Sort by time (nearest first)
                    bookings.sort((a, b) => a.time.toDate() - b.time.toDate());

                    const now = new Date();

                    bookings.forEach(booking => {
                        const slotTime = booking.time.toDate();
                        const service = booking.service;
                        
                        let statusBadge = '';
                        if (booking.status === 'arrived') {
                            statusBadge = '<span class="badge badge-success">Arrived</span>';
                        } else if (booking.status === 'no-show') {
                            statusBadge = '<span class="badge badge-danger">Missed</span>';
                        } else if (booking.autoRescheduled) {
                            statusBadge = '<span class="badge badge-secondary">Rescheduled</span>';
                        } else if (booking.status === 'cancelled') {
                            statusBadge = '<span class="badge badge-danger">Cancelled</span>';
                        } else if (slotTime > now) {
                            statusBadge = '<span class="badge badge-primary">Upcoming</span>';
                        } else {
                            statusBadge = '<span class="badge badge-gray">Past</span>';
                        }

                        const canMarkArrived = booking.status !== 'arrived' && booking.status !== 'cancelled' && booking.status !== 'no-show';

                        const bookingElement = document.createElement('div');
                        bookingElement.className = 'service-list-item';
                        bookingElement.innerHTML = `
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-lg text-gray-800">${service.name}</h3>
                                <div class="flex items-center mt-1 gap-2">
                                    ${statusBadge}
                                    ${booking.bookedByName ? `<span class="badge badge-secondary">${booking.bookedByName}</span>` : ''}
                                </div>
                                <p class="text-sm text-gray-600 mt-2">${service.address}</p>
                                <div class="flex items-center mt-3 text-sm text-gray-700">
                                    <i class="fas fa-clock text-blue-500 mr-2"></i>
                                    <span>${slotTime.toLocaleDateString()} at ${slotTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0 w-full md:w-auto mt-3 md:mt-0">
                                ${canMarkArrived ? `
                                <button 
                                    class="admin-booking-arrived-btn btn-secondary text-sm py-2 px-3 flex items-center justify-center w-full md:w-auto" 
                                    data-service-id="${service.id}" 
                                    data-slot-id="${booking.slotId}">
                                    <i class="fas fa-check mr-1"></i> Arrived
                                </button>
                                ` : ''}
                            </div>
                        `;

                        adminBookingsList.appendChild(bookingElement);
                    });
                } catch (error) {
                    console.error('Error loading admin bookings:', error);
                    adminBookingsList.innerHTML = `<p class="text-sm text-red-500">Failed to load bookings: ${error.message}</p>`;
                }
            };

            // Event delegation for admin bookings Arrived button
            if (adminBookingsList) {
                adminBookingsList.addEventListener('click', async (e) => {
                    const arrivedBtn = e.target.closest('.admin-booking-arrived-btn');
                    if (!arrivedBtn) return;

                    const serviceId = arrivedBtn.dataset.serviceId;
                    const slotId = arrivedBtn.dataset.slotId;
                    const confirmed = await showMessageBox('Confirm Arrival', 'Mark this booking as arrived?', 'confirm');
                    if (!confirmed) return;

                    views.loading.style.display = 'flex';
                    await updateDoc(doc(db, `services/${serviceId}/slots`, slotId), {
                        status: 'arrived',
                        arrived: true
                    });
                    views.loading.style.display = 'none';
                    loadAdminBookings();
                });
            }

            // --- NEW: My Bookings View Logic (with Arrival/Reschedule) ---
            const loadUserBookings = async () => {
                if (!currentUser) return;
                
                const userBookingsList = document.getElementById('user-bookings-list');
                const noBookingsMessage = document.getElementById('no-bookings-message');
                
                userBookingsList.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                noBookingsMessage.classList.add('hidden');
                
                // Get all services
                const servicesSnapshot = await getDocs(collection(db, "services"));
                const services = {};
                servicesSnapshot.forEach(doc => {
                    services[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // Find all slots booked by the current user
                let allUserBookings = [];
                
                for (const serviceId in services) {
                    const q = query(
                        collection(db, `services/${serviceId}/slots`), 
                        where("bookedBy", "==", currentUser.uid)
                    );
                    
                    const slotsSnapshot = await getDocs(q);
                    
                    slotsSnapshot.forEach(doc => {
                        allUserBookings.push({
                            slotId: doc.id,
                            ...doc.data(),
                            service: services[serviceId]
                        });
                    });
                }

                // Sort bookings by time (most recent first)
                allUserBookings.sort((a, b) => b.time.toDate() - a.time.toDate());
                
                userBookingsList.innerHTML = ''; // Clear spinner

                if (allUserBookings.length === 0) {
                    noBookingsMessage.classList.remove('hidden');
                    return;
                }
                
                const now = new Date();
                const fifteenMinutes = 15 * 60 * 1000;
                let autoRescheduleCandidate = null; // NEW: store one booking to auto-reschedule

                allUserBookings.forEach(booking => {
                    const slotTime = booking.time.toDate();
                    const service = booking.service;
                    
                    let statusBadge = '';
                    let actionButtons = '';
                    
                    const isUpcoming = slotTime > now;
                    const timeToAppt = slotTime.getTime() - now.getTime();
                    const isCheckinWindow = timeToAppt > 0 && timeToAppt < fifteenMinutes; // 15 min check-in window
                    const isPastDue = now.getTime() > (slotTime.getTime() + fifteenMinutes); // 15 min grace period

                    // NEW: pick one missed, still-booked slot for automatic one-time rescheduling
                    if (
                        !autoRescheduleCandidate &&
                        now.getTime() > slotTime.getTime() &&
                        !booking.arrived &&
                        booking.status === 'booked' &&
                        !booking.autoRescheduled
                    ) {
                        autoRescheduleCandidate = {
                            serviceId: service.id,
                            oldSlotId: booking.slotId
                        };
                    }

                    // Track missed slots that were already auto-rescheduled once
                    if (
                        now.getTime() > slotTime.getTime() &&
                        !booking.arrived &&
                        booking.status === 'booked' &&
                        booking.autoRescheduled
                    ) {
                        if (!window.__secondMissedSlots) {
                            window.__secondMissedSlots = [];
                        }
                        window.__secondMissedSlots.push({ serviceId: service.id, slotId: booking.slotId });
                    }
                    
                    if (booking.status === 'arrived') {
                        statusBadge = `<span class="badge badge-success">Checked In</span>`;
                    } else if (booking.status === 'cancelled') {
                        statusBadge = `<span class="badge badge-danger">Cancelled</span>`;
                    } else if (isUpcoming) {
                        statusBadge = `<span class="badge badge-primary">Upcoming</span>`;
                        
                        if (isCheckinWindow) {
                            actionButtons += `
                                <button class="user-arrived-btn btn-primary text-sm py-2 px-3 flex-1 justify-center" data-service-id="${service.id}" data-slot-id="${booking.slotId}">
                                    <i class="fas fa-map-marker-alt mr-2"></i> I've Arrived
                                </button>
                            `;
                        }
                        actionButtons += `
                            <button class="get-directions-btn bg-indigo-100 text-indigo-700 text-sm font-semibold py-2 px-3 rounded-lg hover:bg-indigo-200 transition flex-1 justify-center" data-address="${service.address}">
                                <i class="fas fa-directions mr-1"></i> Directions
                            </button>
                        `;
                    } else { // It's in the past
                        if (booking.arrived && booking.autoRescheduled) {
                            statusBadge = `<span class="badge badge-secondary">Rescheduled</span>`;
                        } else if (booking.arrived) {
                            statusBadge = `<span class="badge badge-gray">Completed</span>`;
                        } else if (isPastDue && booking.status !== 'cancelled') {
                            statusBadge = `<span class="badge badge-danger">Missed (No-Show)</span>`;
                            actionButtons = `
                                <button class="find-next-slot-btn btn-warning text-sm py-2 px-3 flex-1 justify-center" data-service-id="${service.id}" data-old-slot-id="${booking.slotId}">
                                    <i class="fas fa-search mr-2"></i> Find Next Slot
                                </button>
                            `;
                        } else {
                            statusBadge = `<span class="badge badge-gray">Completed</span>`; // Default past
                        }
                    }

                    // Extra message text for special statuses (rescheduled / missed)
                    let statusMessage = '';
                    if (booking.arrived && booking.autoRescheduled) {
                        statusMessage = '<p class="text-xs text-indigo-600 mt-1">This appointment was rescheduled from a missed slot.</p>';
                    } else if (!booking.arrived && isPastDue && booking.status !== 'cancelled') {
                        statusMessage = '<p class="text-xs text-red-500 mt-1">You missed this appointment.</p>';
                    }

                    const bookingElement = document.createElement('div');
                    bookingElement.className = 'service-list-item user-booking-item';
                    bookingElement.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg text-gray-800">${service.name}</h3>
                            <div class="flex items-center mt-1">
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-600 mt-2">${service.address}</p>
                            <div class="flex items-center mt-3 text-sm text-gray-700">
                                <i class="fas fa-clock text-blue-500 mr-2"></i>
                                <span>${slotTime.toLocaleDateString()} at ${slotTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            ${statusMessage}
                        </div>
                        <div class="text-right flex-shrink-0 w-full md:w-auto">
                            <div class="flex flex-col sm:flex-row md:flex-col gap-2 user-booking-item-actions">
                                ${actionButtons}
                            </div>
                        </div>
                    `;
                    
                userBookingsList.appendChild(bookingElement);
                });

                // For any slots that were already auto-rescheduled once and now missed again,
                // mark them as no-show (no further automatic rescheduling).
                if (window.__secondMissedSlots && window.__secondMissedSlots.length > 0) {
                    (async () => {
                        const missed = window.__secondMissedSlots;
                        window.__secondMissedSlots = [];
                        for (const item of missed) {
                            try {
                                await updateDoc(doc(db, `services/${item.serviceId}/slots`, item.slotId), {
                                    status: 'no-show'
                                });
                            } catch (e) {
                                console.error('Failed to mark second missed slot as no-show:', e);
                            }
                        }
                    })();
                }

                // Trigger automatic rescheduling once per load, after list is rendered
                if (autoRescheduleCandidate && !autoRescheduleInProgress) {
                    autoRescheduleInProgress = true;
                    (async () => {
                        try {
                            await findAndBookNextSlot(
                                autoRescheduleCandidate.serviceId,
                                autoRescheduleCandidate.oldSlotId
                            );
                        } catch (error) {
                            console.error('Automatic rescheduling failed:', error);
                        } finally {
                            autoRescheduleInProgress = false;
                        }
                    })();
                }
            };

            // Event delegation for "My Bookings" buttons
            document.getElementById('user-bookings-list').addEventListener('click', async (e) => {
                // Get Directions
                const directionsBtn = e.target.closest('.get-directions-btn');
                if (directionsBtn) {
                    const address = directionsBtn.dataset.address;
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
                    window.open(url, '_blank');
                    return;
                }

                // User Arrived
                const arrivedBtn = e.target.closest('.user-arrived-btn');
                if (arrivedBtn) {
                    const serviceId = arrivedBtn.dataset.serviceId;
                    const slotId = arrivedBtn.dataset.slotId;
                    
                    const confirmed = await showMessageBox('Check In', 'Confirm that you have arrived at the location?', 'confirm');
                    if (confirmed) {
                        views.loading.style.display = 'flex';
                        const slotRef = doc(db, `services/${serviceId}/slots`, slotId);
                        await updateDoc(slotRef, { status: 'arrived', arrived: true });
                        loadUserBookings(); // Refresh the list
                        views.loading.style.display = 'none';
                    }
                    return;
                }

                // Find Next Slot (No-Show)
                const findNextBtn = e.target.closest('.find-next-slot-btn');
                if (findNextBtn) {
                    const serviceId = findNextBtn.dataset.serviceId;
                    const oldSlotId = findNextBtn.dataset.oldSlotId;
                    
                    const confirmed = await showMessageBox('Find Next Slot', 'We will try to find the next available slot at this service and book it for you. Your missed appointment will be marked as a no-show. Continue?', 'confirm');
                    if (confirmed) {
                        views.loading.style.display = 'flex';
                        await findAndBookNextSlot(serviceId, oldSlotId);
                        views.loading.style.display = 'none';
                    }
                    return;
                }
            });

            // --- NEW: Find and Book Next Slot Function ---
            const findAndBookNextSlot = async (serviceId, oldSlotId) => {
                try {
                    // 1. Find the next available slot for this service
                    const q = query(
                        collection(db, `services/${serviceId}/slots`),
                        where("booked", "==", false),
                        where("time", ">", new Date()),
                        // orderBy("time") - NOTE: This requires a composite index in Firestore.
                        // To avoid this, we'll sort in the client.
                    );
                    
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        await showMessageBox('No Slots Available', 'No next available slots were found for this service.');
                        return;
                    }

                    let slots = [];
                    snapshot.forEach(doc => slots.push({ id: doc.id, ...doc.data() }));
                    // Sort client-side to find the earliest
                    slots.sort((a, b) => a.time.toDate() - b.time.toDate());
                    const nextSlot = slots[0];
                    const nextSlotTime = nextSlot.time.toDate();

                    // 2. Mark the old slot as no-show
                    const oldSlotRef = doc(db, `services/${serviceId}/slots`, oldSlotId);
                    await updateDoc(oldSlotRef, { status: 'no-show' });

                    // 3. Book the new slot
                    const newSlotRef = doc(db, `services/${serviceId}/slots`, nextSlot.id);
                    const newSlotUpdate = {
                        booked: true,
                        bookedBy: currentUser.uid,
                        bookedByName: currentUserDetails.name,
                        bookedAt: serverTimestamp(),
                        status: 'booked'
                    };
                    // Flag slots that were created via automatic rescheduling
                    if (autoRescheduleInProgress) {
                        newSlotUpdate.autoRescheduled = true;
                    }
                    await updateDoc(newSlotRef, newSlotUpdate);

                    // 4. Notify user
                    await showMessageBox('Rescheduled!', `You missed your appointment, but we've successfully rescheduled you for ${nextSlotTime.toLocaleString()}. Please be on time!`);
                    
                    // For automatic rescheduling we skip the immediate reload to avoid recursion
                    if (!autoRescheduleInProgress) {
                        loadUserBookings(); // Refresh the list when triggered manually
                    }

                } catch (error) {
                    console.error("Error finding next slot:", error);
                    await showMessageBox('Error', `An error occurred while trying to reschedule: ${error.message}`);
                }
            };

            // --- Modal & Receipt Logic ---
            document.getElementById('close-receipt-btn').addEventListener('click', () => {
                receiptModal.style.display = 'none';
            });

            document.getElementById('download-receipt-btn').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const receiptContent = document.getElementById('receipt-content');
                
                html2canvas(receiptContent).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF();
                    const imgProps= pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save('SwiftMeet-Appointment.pdf');
                });
            });

            document.getElementById('get-directions-btn').addEventListener('click', (e) => {
                const address = e.target.dataset.address;
                if (address) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
                    window.open(url, '_blank');
                }
            });

        </script>
    </body>
    </html>